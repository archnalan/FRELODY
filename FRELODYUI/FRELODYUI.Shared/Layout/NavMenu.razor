<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">FRELODY</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable">
    <nav class="h-100 d-flex flex-column">
        <CascadingAuthenticationState>
        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/dashboard" Match="NavLinkMatch.All">
                        <span class="bi bi-card-list-nav-menu" aria-hidden="true"></span> 
                        Dashboard
                        <span class="ms-auto compose-alert-dot"
                                  data-bs-toggle="tooltip"
                                  title="Popular"></span>
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link align-items-center" href="/songs-library" Match="NavLinkMatch.Prefix">
                        <span class="bi bi-collection-play-fill-nav-menu" aria-hidden="true"></span> Library
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link align-items-center" href="/playlists" Match="NavLinkMatch.Prefix">
                            <span class="bi bi-music-note-list-nav-menu" aria-hidden="true"></span> Playlists
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="compose" Match="NavLinkMatch.Prefix">
                            <span class="bi bi-pencil-square-nav-menu" aria-hidden="true"></span> 
                            Compose
                            <span class="ms-auto compose-alert-dot"
                                  data-bs-toggle="tooltip"
                                  title="Popular"></span>
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="/chords" Match="NavLinkMatch.Prefix">
                            <span class="bi bi-sliders-nav-menu" aria-hidden="true"></span> Chords
                    </NavLink>
                </div>
                    @if (isPremiumUser)
                    {
                        <div class="nav-item px-3">
                            <NavLink class="nav-link" href="/song/import" Match="NavLinkMatch.Prefix">
                                <span class="bi bi-download-nav-menu" aria-hidden="true"></span>                              
                                Song Import
                            </NavLink>
                        </div>

                    }
                    else
                    {
                        <div class="nav-item px-3">
                            <span class="ms-3 disabled text-muted"
                                  style="cursor: pointer;">
                                <span class="bi bi-download-nav-menu"
                                      aria-hidden="true"></span>
                                Song Import
                            </span>
                            <i class="bi bi-stars icon-premium"
                                            data-bs-toggle="tooltip"
                                            title="Premium Feature"></i>
                        </div>
                    }
                   
                @{
                    var firstName = context.User.FindFirst("FirstName")?.Value;
                    var lastName = context.User.FindFirst("LastName")?.Value;
                    var fullName = firstName + " " + lastName;
                    var displayName = fullName.Length > 15 ? fullName.Substring(0, 15) + "..." : fullName;
                }
                <div class="nav-item px-3 dropdown dropup mt-auto">
                    <button class="nav-link dropdown-toggle w-100 d-flex justify-content-between align-items-center" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="user-avatar-circle me-2">
                            <span>
                                    @(firstName?.FirstOrDefault())@(lastName?.FirstOrDefault())
                                </span>
                        </div>                           
                            @displayName
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                                <a class="dropdown-item" href="/">
                                <i class="bi bi-house-door"></i>Home
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/user-profile/@(context.User.FindFirst("UserId")?.Value)">
                                <i class="bi bi-person"></i>View Profile
                            </a>
                        </li>
                        @if (isPremiumUser)
                        {
                            <li>
                                <a class="dropdown-item" href="/users">
                                    <i class="bi bi-people"></i>Accounts
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="my-2">
                                <span class="ms-3 disabled text-muted"
                                      style="cursor: pointer;">
                                    <i class="bi bi-people"></i>Accounts
                                </span>
                                <i class="bi bi-stars icon-premium"
                                   data-bs-toggle="tooltip"
                                   title="Premium Feature"></i>
                            </li>
                        }
                        <li class="form-check form-switch mx-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="switchCheckChecked"
                                   checked="@(!isDarkTheme)" @onchange="ToggleTheme">
                            <label class="form-check-label" for="switchCheckChecked" @onclick:preventDefault>Theme</label>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item text-danger border-0 bg-transparent w-100 text-start" @onclick="TriggerLogout">
                            <i class="bi bi-box-arrow-right"></i>Log out
                        </button></li>
                    </ul>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="nav-item px-3 mt-auto">
                    <NavLink class="nav-link" href="/login">
                        <span class="bi bi-box-arrow-in-right-nav-menu" aria-hidden="true"></span> Login
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>
        </CascadingAuthenticationState>
    </nav>
</div>

<DialogModal IsVisible="@_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    private bool isDarkTheme = false;
    private bool isPremiumUser;

    protected override async Task OnInitializedAsync()
    {
        var resp = await _globalAuth.IsPremiumUser();
        isPremiumUser = resp.IsSuccess && resp.Data;

        var savedTheme = await _storageService.GetItemAsync<string>("Theme");
        if (!string.IsNullOrEmpty(savedTheme))
        {
            isDarkTheme = savedTheme == "dark";
            await ApplyTheme(savedTheme);
        }
    }

    private void TriggerLogout()
    {
        var modalOptions = new ModalOptionDto
        {
            Title = "Confirm Logout",
            Message = "Are you sure you want to log out?",
            ButtonText = "Logout",
            OptionType = OptionType.Warning,
            Context = new ModalContext { ActionType = "LogoutUser" }
        };
        _modalService.Show(modalOptions);
    }

    private async Task LogoutUser()
    {
        await _globalAuth.MarkUserAsLoggedOutAsync();
        _navManager.NavigateTo("/login", replace: true);
    }

    private async Task ToggleTheme()
    {
        isDarkTheme = !isDarkTheme;
        var theme = isDarkTheme ? "dark" : "light";
        await ApplyTheme(theme);
        await _storageService.SetItemAsync("Theme", theme);
    }

    private async Task ApplyTheme(string theme)
    {
        await JsRt.InvokeVoidAsync("eval",
            $"document.documentElement.setAttribute('data-bs-theme', '{theme}')");
    }
    private async Task ConfirmModal()
    {
        if (_modalService.CurrentModal?.Context?.ActionType == "LogoutUser")
        {
            await LogoutUser();
        }
        else
        {
            _modalService.Close();
        }
        await CloseModal();
    }
    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }
}

<script>
    //Replacing onclick="document.querySelector('.navbar-toggler').click()"
    document.addEventListener('click', e => {
      const toggler = document.querySelector('.navbar-toggler');
      if (!toggler) return;
      // Only act on small screens where the checkbox controls visibility
      if (window.matchMedia('(max-width: 640px)').matches) {
          // Check if it's a NavLink or a dropdown item
          const navLink = e.target.closest('.nav-item a.nav-link');
          const dropdownItem = e.target.closest('.dropdown-item');

          if (navLink || dropdownItem) {
              toggler.checked = false;
          }
      }
  });
</script>
