@page "/songs-list"
@using Microsoft.AspNetCore.Components.Web.Virtualization
@inject ILogger<SongList> _logger

<Virtualize @key="RefreshKey" 
            Context="song"
            ItemsProvider="ProvideSongsAsync"
            ItemSize="170"
            OverscanCount="3"
            @ref="_virtualize">
    <ItemContent>
        <div class="@(ViewStyle == ActiveView.Expanded ? "col-12 mb-4" : "col-12 col-md-6 col-lg-4 col-xl-3 mb-4")" 
                @onclick="@(() => OnSongDisplay(song.IdString ?? ""))" style="cursor:pointer">
            <div class="card h-100 shadow-sm" style="border-radius:0.5rem">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between mb-3">
                        <h5 class="card-title mb-3">
                            <span>@song.Id.</span><!--Holds song number-->
                            <span class="ms-2">@song.ValueText</span>
                        </h5>
                        <!--close icon-->
                        <span class="cursor-pointer text-muted ms-2" 
                            @onclick="() => RemoveSong(song.IdString)"
                            @onclick:stopPropagation>
                            <i class="bi bi-x"></i>
                        </span>

                    </div>
                    <div>
                        <span class="font-weight-light text-muted">@song.IdString</span>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-outline-secondary btn-sm me-2" 
                                @onclick="() => NavigateToDetails(song.IdString)"
                                @onclick:stopPropagation>
                            <i class="bi bi-list"></i>
                        </button>
                        <button class="btn btn-primary btn-sm" @onclick="@(() => OnSongDisplay(song.IdString))"><i class="bi bi-play-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </ItemContent>
    <Placeholder>
        <div class="@(ViewStyle == ActiveView.Expanded ? "col-12 mb-4" : "col-12 col-md-6 col-lg-4 col-xl-3 mb-4")">
            <div class="card h-100 placeholder-wave shadow" style="border-radius:0.5rem">
                <div class="card-body">
                    <h5 class="card-title">
                        <span class="placeholder col-7 mb-3"></span>
                    </h5>
                    <span class="placeholder col-3"></span>
                    <div class="d-flex justify-content-end mt-3">
                        <span class="placeholder col-3 me-2"></span>
                        <span class="placeholder col-2"></span>
                    </div>
                </div>
            </div>
        </div>
    </Placeholder>
</Virtualize>

<DialogModal IsVisible="_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    [Parameter] public ActiveView ViewStyle { get; set; }
    private string error = string.Empty;
    private bool IsNavigating = false;

    private string _searchTerm = string.Empty;
    private string RefreshKey = Guid.NewGuid().ToString();

    private Virtualize<ComboBoxDto>? _virtualize;

    protected override Task OnInitializedAsync()
    {
        // Virtualize will load on first render via ItemsProvider.
        return Task.CompletedTask;
    }

    public async Task SetActiveView(ActiveView changeStyle)
    {
        ViewStyle = changeStyle;
        await Task.Delay(100);
        StateHasChanged();
    }

    private async ValueTask<ItemsProviderResult<ComboBoxDto>> ProvideSongsAsync(ItemsProviderRequest request)
    {
        try
        {
            error = string.Empty;

            var offset = request.StartIndex;
            var limit = request.Count <= 0 ? 10 : request.Count;

            if (!string.IsNullOrWhiteSpace(_searchTerm))
            {
                var response = await _songsApi.SearchSongs(_searchTerm, offset, limit);
                var page = response?.Content;
                var items = page?.Data ?? new List<ComboBoxDto>();
                var total = page?.TotalSize ?? 0;
                return new ItemsProviderResult<ComboBoxDto>(items, total);
            }
            else
            {
                var response = await _songsApi.GetSongs(offset, limit);
                var page = response?.Content;
                var items = page?.Data ?? new List<ComboBoxDto>();
                var total = page?.TotalSize ?? 0;
                return new ItemsProviderResult<ComboBoxDto>(items, total);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error fetching songs during virtualization.");
            error = $"Error fetching songs: {ex.Message}";
            return new ItemsProviderResult<ComboBoxDto>(Array.Empty<ComboBoxDto>(), 0);
        }
    }

    private void RemoveSong(string? songId)
    {
        if(!string.IsNullOrEmpty(songId))
        {
            _modalService.Show(new ModalOptionDto
            {
                Title = "Delete Song",
                Message = "Are you sure you want to delete this song?",
                DangerText = "This action cannot be undone.",
                ButtonText = "Delete",
                OptionType = OptionType.Confirmation,
                Context = new ModalContext { ActionType = "DeleteSong", Data = songId }
            });
        }         
    }

    public async Task SearchTermChanged(string searchTerm)
    {
        _searchTerm = searchTerm;
        RefreshKey = Guid.NewGuid().ToString();
        await Task.CompletedTask;
        StateHasChanged();
    }

    private async Task Refresh()
    {
        error = string.Empty;
        if (_virtualize is not null)
            await _virtualize.RefreshDataAsync();
    }

    private void NavigateToDetails(string id)
    {
        _navManager.NavigateTo($"/player/details/{id}");
    }

    private void NavigateToPlay(string id)
    {
        _navManager.NavigateTo($"/player/{id}");
    }

    private void OnSongDisplay(string songId)
    {
        try
        {
            IsNavigating = true;
            StateHasChanged();
            _navManager.NavigateTo($"/songs/{songId}");
        }
        catch (Exception ex)
        {
            _logger.LogError($"Error navigating to song: {ex.Message}");
            _modalService.Show(new ModalOptionDto
            {
                Title = "Error",
                Message = "An error occurred while trying to display the song.",
                ButtonText = "Close",
                OptionType = OptionType.Error
            });
        }
        finally
        {
            IsNavigating = false;
            StateHasChanged();
        }
    }

    private async Task ConfirmModal()
    {
        if (_modalService.CurrentModal?.Context?.ActionType == "DeleteSong")
        {
            var response = await _songsApi.DeleteSong(_modalService.CurrentModal.Context.Data?.ToString() ?? string.Empty);

            if(response.IsSuccessStatusCode)
            {
                await Refresh();
            }
            else
            {
                var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                _modalService.Show(new ModalOptionDto
                {
                    Title = "Error Deleting Song",
                    Message = errorMessage,
                    ButtonText = "Close",
                    OptionType = OptionType.Error
                });
            }
        }
        else
        {
            _modalService.Close();
        }
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }
}
