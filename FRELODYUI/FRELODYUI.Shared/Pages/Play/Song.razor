@using FRELODYSHRD.Dtos.SubDtos
@using FRELODYUI.Shared.Pages.Chord
@inject ILogger<Song> _logger
@implements IDisposable

<div class="song-container" @ref="songContainerRef">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Loading song...</p>
        </div>
    }
    else if (song != null)
    {
        <!-- Modern Header with Actions -->
        <div class="song-header">
            <button class="header-action-btn back-btn" @onclick="GoBack" title="Go back">
                <i class="bi bi-chevron-left"></i>
            </button>

            <div class="song-title-section" style="font-family:@fontFamily">
                <div class="song-title-wrapper mb-3">
                    @if (song.SongNumber.HasValue)
                    {
                        <span class="song-number">@song.SongNumber.Value.ToString("D3")</span>
                    }
                    <h1 class="song-title">@song.Title</h1>
                </div>
                <SongRating SongId="@SongId" ShowSummary="true" ShowPanel="false" />
            </div>

            <div class="header-actions">
                <!-- Settings Dropdown -->
                <div class="settings-dropdown-wrapper">
                    <button class="header-action-btn settings-btn @(showSettingsDropdown ? "active" : "")" 
                            @onclick="ToggleSettingsDropdown"
                            title="Display settings">
                        <i class="bi bi-gear"></i>
                    </button>
                    
                    @if (showSettingsDropdown)
                    {
                        <div class="settings-dropdown-overlay" onclick="()=>()"></div>
                        <div class="settings-dropdown" @onclick:stopPropagation>
                            <div class="settings-header">
                                <h6>Display Settings</h6>
                                <button class="close-btn" @onclick="CloseSettingsDropdown">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>

                            <div class="settings-content">
                                <!-- Autoscroll Settings -->
                                <div class="settings-section">
                                    <label class="settings-label">
                                        <i class="bi bi-speedometer2"></i>
                                        Autoscroll Speed
                                    </label>
                                    <div class="setting-control">
                                        <button class="size-btn" @onclick="() => AdjustScrollSpeed(-1)" disabled="@(scrollSpeed <= 0)">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <span class="control-value">@scrollSpeed</span>
                                        <button class="size-btn" @onclick="() => AdjustScrollSpeed(1)" disabled="@(scrollSpeed >= 5)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Font Settings -->
                                <div class="settings-section">
                                    <label class="settings-label">
                                        <i class="bi bi-type"></i>
                                        Chord Font Size
                                    </label>
                                    <div class="setting-control">
                                        <button class="size-btn" @onclick="() => AdjustChordFontSize(-2)">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <span class="size-value">@chordFontSize</span>
                                        <button class="size-btn" @onclick="() => AdjustChordFontSize(2)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="settings-section">
                                    <label class="settings-label">
                                        <i class="bi bi-text-paragraph"></i>
                                        Lyric Font Size
                                    </label>
                                    <div class="setting-control">
                                        <button class="size-btn" @onclick="() => AdjustLyricFontSize(-2)">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <span class="size-value">@lyricFontSize</span>
                                        <button class="size-btn" @onclick="() => AdjustLyricFontSize(2)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Display Mode -->
                                <div class="settings-section">
                                    <label class="settings-label">
                                        <i class="bi bi-eye"></i>
                                        Display Mode
                                    </label>
                                    <select class="settings-select" @bind="songDisplayMode">
                                        <option value="@SongDisplay.LyricsAndChordsAndCharts">Lyrics, Chords & Charts</option>
                                        <option value="@SongDisplay.LyricsAndChords">Lyrics & Chords</option>
                                        <option value="@SongDisplay.LyricsOnly">Lyrics Only</option>
                                    </select>
                                </div>

                                <!-- Chord Display Position -->
                                @if (songDisplayMode == SongDisplay.LyricsAndChords 
                                || songDisplayMode == SongDisplay.LyricsAndChordsAndCharts)
                                {
                                    <div class="settings-section">
                                        <label class="settings-label">
                                            <i class="bi bi-music-note"></i>
                                            Chord Position
                                        </label>
                                        <select class="settings-select" @bind="chordDisplayMode">
                                            <option value="@ChordDisplay.Above">Above Lyrics</option>
                                            <option value="@ChordDisplay.Inline">Inline</option>
                                        </select>
                                    </div>
                                }

                                <!-- Font Family Selection -->
                                <div class="settings-section">
                                    <label class="settings-label">
                                        <i class="bi bi-fonts"></i>
                                        Font Style
                                    </label>
                                    <select class="settings-select" @bind="fontFamily">
                                        <option value="system-ui, -apple-system, 'Segoe UI'">System Default</option>
                                        <option value="'Georgia', serif">Georgia</option>
                                        <option value="'Arial', sans-serif">Arial</option>
                                        <option value="'Courier New', monospace">Courier New</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                        <option value="'Kanit','Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'">Kanit</option>
                                        <option value="'Montserrat', sans-serif">Montserrat</option>
                                    </select>
                                </div>
                                <div class="settings-footer">
                                    <!-- Save Settings Button -->
                                    <button class="save-settings-btn" @onclick="SaveDisplaySettings" disabled="@isSavingSettings">
                                        @if (isSavingSettings)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-check-circle me-2"></i>
                                        }
                                        Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <button class="btn btn-primary dropdown-toggle"
                        type="button"
                        @onclick="ToggleDropdown"
                        disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    }
                    else
                    {
                        <i class="bi bi-upload me-1"></i>
                    }
                    Share
                </button>

                @if (showShareDropdown)
                {
                    <ShareDropdown Song="song" 
                                   ShowShareDropdown="@showShareDropdown" 
                                   OnActionCompleted="() => StateHasChanged()" 
                                   OnCustomizeSong="(songId) => CustomizeSong(songId)" />
                    <div style="z-index:0" class="modal-backdrop bg-transparent" @onclick="() => showShareDropdown = false"></div>                    
                }
            </div>
        </div>

        <!-- Autoscroll and Controls Section -->
        <div class="fret-section">

            @if (songDisplayMode != SongDisplay.LyricsOnly)
            {
                <div class="controls-section">
                    <!-- Autoscroll Control -->
                    <div class="control-group">
                        <button class="control-action-btn @(isAutoScrolling ? "active" : "")"
                                @onclick="ToggleAutoScroll"
                                title="@(isAutoScrolling ? "Stop autoscroll" : "Start autoscroll")">
                            <i class="bi bi-@(isAutoScrolling ? "pause-fill" : "play-fill")"></i>
                        </button>
                        <div class="control-wrapper">
                            <label class="control-label">Autoscroll</label>
                            <div class="control-buttons">
                                <button class="control-btn" @onclick="() => AdjustScrollSpeed(-1)" disabled="@(scrollSpeed <= 0)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="control-value">@scrollSpeed</span>
                                <button class="control-btn" @onclick="() => AdjustScrollSpeed(1)" disabled="@(scrollSpeed >= 5)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Transpose Control -->
                    <div class="control-group">
                        <button class="control-reset-btn" @onclick="ResetTranspose" title="Reset transpose">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <div class="control-wrapper">
                            <label class="control-label">Transpose</label>
                            <div class="control-buttons">
                                <button class="control-btn" @onclick="DecreaseTranspose" disabled="@(transpose <= -12)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="control-value">@transpose</span>
                                <button class="control-btn" @onclick="IncreaseTranspose" disabled="@(transpose >= 12)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Capo Control -->
                    <div class="control-group">
                        <div class="control-wrapper">
                            <label class="control-label">Capo</label>
                            <div class="control-buttons">
                                <button class="control-btn" @onclick="DecreaseCapo" disabled="@(capo <= 0)">
                                    <i class="bi bi-dash"></i>
                                </button>
                                <span class="control-value">@capo</span>
                                <button class="control-btn" @onclick="IncreaseCapo" disabled="@(capo >= 12)">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>
                        <button class="control-reset-btn" @onclick="ResetCapo" title="Reset capo">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>

                @if (showCharts && uniqueSongChords.Any())
                {
                    <div class="control-divider"></div>
                    <div class="chord-charts-section">
                        <div class="chord-charts-header">
                            <h5 class="chord-charts-title">
                                <i class="bi bi-music-note-list"></i>
                                Song Chords
                            </h5>
                            <button class="toggle-grid-btn" @onclick="ToggleChordGrid" title="@(showChordGrid ? "Show slider" : "Show all")">
                                <i class="bi bi-@(showChordGrid ? "list" : "grid-3x3")"></i>
                            </button>
                        </div>

                        @if (showChordGrid)
                        {
                            <div class="chord-charts-grid">
                                @foreach (var chord in uniqueSongChords)
                                {
                                    <div class="chord-chart-card">
                                        <h6 class="chord-chart-name">@GetTransposedChordName(chord.ChordName)</h6>
                                        <ChordCarousel Chord="@chord"
                                                       Size="CarouselSize.Medium"
                                                       ShowActions="false"
                                                       CarouselId="@($"inline-carousel-{chord.Id}")" />
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="chord-charts-slider">
                                <button class="slider-nav-btn slider-prev" @onclick="ScrollChartsLeft" disabled="@(chordScrollPosition <= 0)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <div class="chord-charts-track" @ref="chordChartsTrackRef">
                                    @foreach (var chord in uniqueSongChords)
                                    {
                                        <div class="chord-chart-card">
                                            <h6 class="chord-chart-name">@GetTransposedChordName(chord.ChordName)</h6>
                                            <ChordCarousel Chord="@chord"
                                                           Size="CarouselSize.Medium"
                                                           ShowActions="false"
                                                           CarouselId="@($"inline-carousel-{chord.Id}")" />
                                        </div>
                                    }
                                </div>
                                <button class="slider-nav-btn slider-next" @onclick="ScrollChartsRight">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        }
                        <div class="w-100 d-flex justify-content-end">
                            <small> <i class="bi bi-music-note-beamed me-2"></i> @uniqueSongChords.Count chords</small>
                        </div>
                    </div>

                }
            }
        </div>

        <!-- Song Content with Dynamic Styling -->
        <div class="song-content" style="@GetSongContentStyle()">
            @if (song.SongParts?.Any() == true)
            {
                foreach (var verse in song.SongParts.OrderBy(v => v.PartNumber))
                {
                    <div class="verse-section">
                        <h4 class="verse-title">
                            Verse @verse.PartNumber.ToString("D2")
                        </h4>
                        @if (verse.LyricLines?.Any() == true)
                        {
                            foreach (var line in verse.LyricLines.OrderBy(l => l.LyricLineOrder))
                            {
                                <div class="lyric-line">
                                    @if (line.LyricSegments?.Any() == true)
                                    {
                                        foreach (var segment in line.LyricSegments.OrderBy(s => s.LyricOrder))
                                        {
                                            <div class="lyric-segment @GetChordDisplayClass()">
                                                @if (segment.Chord != null && 
                                                (songDisplayMode == SongDisplay.LyricsAndChords 
                                                || songDisplayMode == SongDisplay.LyricsAndChordsAndCharts))
                                                {
                                                    <span class="chord @GetChordAlignmentClass(segment)" 
                                                          style="font-size: @(chordFontSize)px;"
                                                          @onmouseenter="(e) => ShowChordPopover(segment.Chord, e)"
                                                          @onmouseleave="HandleChordMouseLeave">
                                                        @GetTransposedChordName(segment.Chord.ChordName)
                                                    </span>
                                                }
                                                <span class="lyric" style="font-size: @(lyricFontSize)px;">
                                                    @segment.Lyric
                                                </span>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            }
        </div>

        <!-- Chord Popover -->
        @if (showChordPopover && hoveredChord != null)
        {
            <div class="chord-popover-overlay" 
                 style="top: @(popoverTop)px; left: @(popoverLeft)px;"
                 @onmouseenter="() => isMouseOverPopover = true"
                 @onmouseleave="HideChordPopover">
                <div class="chord-popover-content">
                    <div class="chord-popover-header">
                        <h6>@hoveredChord.ChordName</h6>
                        <button class="popover-close-btn" @onclick="HideChordPopover">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    @if (hoveredChord.ChordCharts?.Any() == true)
                    {
                        <ChordCarousel Chord="@hoveredChord"
                                       Size="CarouselSize.Popover"
                                       ShowActions="false"
                                       CarouselId="@($"popover-carousel-{hoveredChord.Id}")" />
                    }
                    else
                    {
                        <div class="chord-popover-empty">
                            <i class="bi bi-music-note"></i>
                            <p>No chord chart available</p>
                        </div>
                    }
                </div>
            </div>
        }

        <div class="song-rating">
            <!-- Bottom Rating Panel -->
            <SongRating SongId="@SongId" ShowSummary="false" ShowPanel="true" />
        </div>
    }
</div>

@if (_modalService.IsModalVisible)
{
    <DialogModal IsVisible="true"
                 Modal="@_modalService.CurrentModal"
                 OnCloseModal="CloseModal"
                 OnConfirmModal="ConfirmModal" />
}

@code {
    [Parameter] public string SongId { get; set; } = string.Empty;

    private SongDto? song;
    private bool isLoading = true;
    private int transpose = 0;
    private int capo = 0;
    private Dictionary<string, int>? chordScale;
    private string[]? originalChords;
    private string? currentUserId;
    private ElementReference songContainerRef;
    private ElementReference chordChartsTrackRef;

    // Display Settings
    private bool showSettingsDropdown = false;
    private bool isSavingSettings = false;
    private int chordFontSize = 14;
    private int lyricFontSize = 18;
    private string fontFamily = "system-ui, -apple-system, 'Montserrat', Roboto, sans-serif";
    private SongDisplay songDisplayMode = SongDisplay.LyricsAndChordsAndCharts;
    private ChordDisplay chordDisplayMode = ChordDisplay.Above;

    // Autoscroll
    private bool isAutoScrolling = false;
    private int scrollSpeed = 3; // pixels per second
    private System.Threading.Timer? autoScrollTimer;
    private const string ApiBaseUrl = "https://localhost:7077";

    // Chord Charts
    private List<ChordDto> uniqueSongChords = new();
    private bool showChordGrid = false;
    private int chordScrollPosition = 0;

    // Chord Popover
    private bool showChordPopover = false;
    private ChordDto? hoveredChord;
    private int currentChartIndex = 0;
    private double popoverTop = 0;
    private double popoverLeft = 0;
    private bool isMouseOverPopover = false;
    private System.Threading.Timer? popoverTimer;

    private bool showCharts => songDisplayMode == SongDisplay.LyricsAndChordsAndCharts;
    private bool showShareDropdown = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Ensure JS functions are loaded
            try
            {
                // Test that smoothScrollBy exists
                await JsRt.InvokeVoidAsync("smoothScrollBy", 0);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "JavaScript functions not loaded properly");
            }
        }
    }
    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(SongId))
            await LoadSong();

        var userResult = await _globalAuth.GetAuthenticatedUserAsync();
        if (userResult.IsSuccess && userResult.Data != null)
        {
            currentUserId = userResult.Data.Id;
            await LoadUserSettings();
            await LoadSongSpecificSettings();
        }
    }

    private async Task LoadUserSettings()
    {
        try
        {
            if (!string.IsNullOrEmpty(currentUserId))
            {
                var response = await _settingsApi.GetUserSettings(currentUserId);
                if (response.IsSuccessStatusCode && response.Content != null)
                {
                    var settings = response.Content;
                    chordFontSize = int.TryParse(settings.ChordFontSize, out var cfs) ? cfs : 14;
                    lyricFontSize = int.TryParse(settings.LyricFontSize, out var lfs) ? lfs : 18;
                    fontFamily = settings.ChordFont ?? fontFamily;
                    songDisplayMode = settings.SongDisplay ?? SongDisplay.LyricsAndChordsAndCharts;
                    chordDisplayMode = settings.ChordDisplay ?? ChordDisplay.Above;
                }
            }
            else
            {
                var storedSettings = await _storageService.GetItemAsync<SettingDto>("DisplaySettings");
                if (storedSettings != null)
                {
                    chordFontSize = int.TryParse(storedSettings.ChordFontSize, out var cfs) ? cfs : 14;
                    lyricFontSize = int.TryParse(storedSettings.LyricFontSize, out var lfs) ? lfs : 18;
                    fontFamily = storedSettings.ChordFont ?? fontFamily;
                    songDisplayMode = storedSettings.SongDisplay ?? SongDisplay.LyricsAndChordsAndCharts;
                    chordDisplayMode = storedSettings.ChordDisplay ?? ChordDisplay.Above;
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading user settings");
        }
    }

    private async Task LoadSongSpecificSettings()
    {
        try
        {
            var key = $"SongSettings_{SongId}";
            var songSettings = await _storageService.GetItemAsync<Dictionary<string, int>>(key);
            if (songSettings != null && songSettings.ContainsKey("scrollSpeed"))
            {
                scrollSpeed = songSettings["scrollSpeed"];
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading song-specific settings");
        }
    }

    private async Task SaveDisplaySettings()
    {
        try
        {
            isSavingSettings = true;

            var settings = new SettingDto
            {
                ChordFontSize = chordFontSize.ToString(),
                LyricFontSize = lyricFontSize.ToString(),
                ChordFont = fontFamily,
                LyricFont = fontFamily,
                SongDisplay = songDisplayMode,
                ChordDisplay = chordDisplayMode
            };

            if (!string.IsNullOrEmpty(currentUserId))
            {
                settings.CreatedBy = currentUserId;
                var response = await _settingsApi.CreateOrUpdateUserSettings(settings);
                if (response.IsSuccessStatusCode)
                {
                    ShowSuccessMessage("Settings saved successfully!");
                }
                else
                {
                    ShowErrorMessage("Failed to save settings");
                }
            }
            else
            {
                await _storageService.SetItemAsync("DisplaySettings", settings);
                ShowSuccessMessage("Settings saved locally!");
            }

            // Save song-specific settings
            var songSettings = new Dictionary<string, int> { { "scrollSpeed", scrollSpeed } };
            await _storageService.SetItemAsync($"SongSettings_{SongId}", songSettings);

            CloseSettingsDropdown();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error saving settings");
            ShowErrorMessage("Failed to save settings");
        }
        finally
        {
            isSavingSettings = false;
        }
    }

    private void ToggleSettingsDropdown()
    {
        showSettingsDropdown = !showSettingsDropdown;
        StateHasChanged();
    }

    private void CloseSettingsDropdown()
    {
        showSettingsDropdown = false;
        StateHasChanged();
    }

    private void AdjustChordFontSize(int delta)
    {
        chordFontSize = Math.Clamp(chordFontSize + delta, 10, 32);
        StateHasChanged();
    }

    private void AdjustLyricFontSize(int delta)
    {
        lyricFontSize = Math.Clamp(lyricFontSize + delta, 12, 40);
        StateHasChanged();
    }

    private void AdjustScrollSpeed(int delta)
    {
        scrollSpeed = Math.Clamp(scrollSpeed + delta, 0, 5);
        StateHasChanged();
    }

    private async Task ToggleAutoScroll()
    {
        isAutoScrolling = !isAutoScrolling;

        if (isAutoScrolling)
        {
            // Check if we're already at bottom
            var atBottom = await JsRt.InvokeAsync<bool>("isAtBottom");
            if (atBottom)
            {
                // Reset to top if at bottom
                await JsRt.InvokeVoidAsync("scrollToTop");
                await Task.Delay(100); // Small delay
            }

            StartAutoScroll();
        }
        else
        {
            StopAutoScroll();
        }

        StateHasChanged();
    }

    private async Task CheckAndScroll()
    {
        if (!isAutoScrolling) return;

        // Check if we're at the bottom
        var isAtBottom = await JsRt.InvokeAsync<bool>("isAtBottom");

        if (isAtBottom)
        {
            // Stop at bottom
            StopAutoScroll();
            isAutoScrolling = false;
            StateHasChanged();
            return;
        }

        // Calculate scroll amount based on speed (0-5)
        // Speed 0 = 0px/sec, Speed 5 = 50px/sec
        // Each tick (100ms) = speed * 10px
        int scrollAmount = scrollSpeed * 10;

        await JsRt.InvokeVoidAsync("smoothScrollBy", scrollAmount);
    }

    private void StartAutoScroll()
    {
        autoScrollTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                // Use the scrollSpeed directly (0-5 scale)
                // Convert to pixels per tick: speed * 10 pixels per tick
                int scrollAmount = scrollSpeed * 10;

                await JsRt.InvokeVoidAsync("smoothScrollBy", scrollAmount);

                // Check if we've reached the bottom
                var scrollPos = await JsRt.InvokeAsync<object>("getScrollPosition");
                await InvokeAsync(CheckAndScroll);
            });
        }, null, 0, 100); // 100ms = 10 times per second
    }

    private void StopAutoScroll()
    {
        autoScrollTimer?.Dispose();
        autoScrollTimer = null;
    }

    private void ToggleChordGrid()
    {
        showChordGrid = !showChordGrid;
        StateHasChanged();
    }

    private async Task ScrollChartsLeft()
    {
        chordScrollPosition -= 200;
        await JsRt.InvokeVoidAsync("scrollElement", chordChartsTrackRef, chordScrollPosition);
    }

    private async Task ScrollChartsRight()
    {
        chordScrollPosition += 200;
        await JsRt.InvokeVoidAsync("scrollElement", chordChartsTrackRef, chordScrollPosition);
    }

    private async Task ShowChordPopover(ChordDto chord, MouseEventArgs e)
    {
        popoverTimer?.Dispose();

        hoveredChord = await LoadChordWithCharts(chord.Id!);
        if (hoveredChord != null)
        {
            currentChartIndex = 0;

            // Calculate position to show above the chord
            var popoverHeight = 280; // Approximate height of compact popover
            var popoverWidth = 280;  // Approximate width of compact popover

            // Position above the chord
            popoverTop = e.ClientY - popoverHeight - 15;
            popoverLeft = e.ClientX - (popoverWidth / 2);

            // Adjust if popover would go off top of screen
            if (popoverTop < 10)
            {
                popoverTop = e.ClientY + 15; // Show below instead
            }

            // Adjust if popover would go off left edge
            if (popoverLeft < 10)
            {
                popoverLeft = 10;
            }

            // Adjust if popover would go off right edge
            // var viewportWidth = await JsRt.InvokeAsync<int>("getViewportDimensions").then(d => d.width);
            // if (popoverLeft + popoverWidth > viewportWidth - 10)
            // {
            //     popoverLeft = viewportWidth - popoverWidth - 10;
            // }

            showChordPopover = true;
            StateHasChanged();
        }
    }

    private void HandleChordMouseLeave()
    {
        popoverTimer?.Dispose();
        popoverTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                if (!isMouseOverPopover)
                {
                    HideChordPopover();
                }
            });
        }, null, 300, Timeout.Infinite);
    }

    private void HideChordPopover()
    {
        showChordPopover = false;
        isMouseOverPopover = false;
        hoveredChord = null;
        currentChartIndex = 0;
        StateHasChanged();
    }

    private void NextChartImage()
    {
        if (hoveredChord?.ChordCharts != null && currentChartIndex < hoveredChord.ChordCharts.Count - 1)
        {
            currentChartIndex++;
            StateHasChanged();
        }
    }

    private void PreviousChartImage()
    {
        if (currentChartIndex > 0)
        {
            currentChartIndex--;
            StateHasChanged();
        }
    }

    private void SetChartIndex(int index)
    {
        currentChartIndex = index;
        StateHasChanged();
    }

    private async Task<ChordDto?> LoadChordWithCharts(string chordId)
    {
        try
        {
            var response = await _chordsApi.GetChordById(chordId);
            if (response.IsSuccessStatusCode)
            {
                return response.Content;
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading chord with charts");
        }
        return null;
    }

    private string GetChordChartImage(ChordChartDto chart)
    {
        if (string.IsNullOrEmpty(chart.FilePath)) return "/_content/FRELODYUI.Shared/images/no_image_placeholder.png";
        
        if (chart.FilePath.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            return chart.FilePath;
            
        return $"{ApiBaseUrl}/{chart.FilePath.TrimStart('/')}";
    }

    private string GetSongContentStyle()
    {
        return $"font-family: {fontFamily};";
    }

    private string GetChordDisplayClass()
    {
        return chordDisplayMode == ChordDisplay.Inline ? "chord-inline" : "chord-above";
    }

    private async Task LoadSong()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var response = await _songsApi.GetSongWithChordsById(SongId);
            if (response.IsSuccessStatusCode)
            {
                song = response.Content;
                InitializeChordScale();
                ExtractUniqueChords();
            }
            else
            {
                var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                ShowErrorMessage($"Failed to load song: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading song with ID: {SongId}", SongId);
            ShowErrorMessage("An unexpected error occurred");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void InitializeChordScale()
    {
        if (song?.SongParts?.Any() == true)
        {
            var chords = song.SongParts
                .SelectMany(part => part.LyricLines ?? Enumerable.Empty<LyricLineDto>())
                .SelectMany(line => line.LyricSegments ?? Enumerable.Empty<LyricSegmentDto>())
                .Where(segment => segment.Chord != null)
                .Select(segment => segment.Chord!.ChordName)
                .Distinct()
                .ToArray();

            if (chords.Length > 0)
            {
                chordScale = ChordTransposer.DetermineScale(chords);
                originalChords = chords;
            }
        }
    }

    private void ExtractUniqueChords()
    {
        if (song?.SongParts?.Any() == true)
        {
            uniqueSongChords = song.SongParts
                .SelectMany(part => part.LyricLines ?? Enumerable.Empty<LyricLineDto>())
                .SelectMany(line => line.LyricSegments ?? Enumerable.Empty<LyricSegmentDto>())
                .Where(segment => segment.Chord != null)
                .Select(segment => segment.Chord!)
                .GroupBy(c => c.ChordName)
                .Select(g => g.First())
                .ToList();
        }
    }

    private string GetTransposedChordName(string originalChordName)
    {
        if (chordScale == null || string.IsNullOrEmpty(originalChordName))
            return originalChordName;

        var totalSemitones = transpose - capo;
        return ChordTransposer.TransposeChord(originalChordName, totalSemitones, chordScale);
    }

    private void IncreaseTranspose() { if (transpose < 12) { transpose++; StateHasChanged(); } }
    private void DecreaseTranspose() { if (transpose > -12) { transpose--; StateHasChanged(); } }
    private void IncreaseCapo() { if (capo < 12) { capo++; StateHasChanged(); } }
    private void DecreaseCapo() { if (capo > 0) { capo--; StateHasChanged(); } }
    private void ResetTranspose() { transpose = 0; StateHasChanged(); }
    private void ResetCapo() { capo = 0; StateHasChanged(); }

    private void ToggleDropdown()
    {
        showShareDropdown = !showShareDropdown;
        StateHasChanged();
    }


    private void CustomizeSong(string? songId)
    {
        if (string.IsNullOrEmpty(songId))
        {
            _modalService.Show(new ModalOptionDto
            {
                Title = "Error",
                Message = "Song ID is required to customize the song.",
                ButtonText = "Close",
                OptionType = OptionType.Error,
                Context = new ModalContext
                {
                    ActionType = "CustomizeSong",
                    Data = "Song ID is null or empty"
                }
            });
            return;
        }
        if (string.IsNullOrEmpty(currentUserId))
        {
            _modalService.Show(new ModalOptionDto
            {
                Title = "Error",
                Message = "You must be logged in to customize a song.",
                ButtonText = "Close",
                HyperlinkText = "Login",
                OptionType = OptionType.Info,
                Context = new ModalContext
                {
                    ActionType = "CustomizeSong",
                    Data = "/login"
                }
            });
            return;
        }
        _navManager.NavigateTo("/compose?songId=" + songId);
    }

    private string GetChordAlignmentClass(LyricSegmentDto segment)
    {
        return segment.ChordAlignment switch
        {
            Alignment.Left => "chord-align-left",
            Alignment.Center => "chord-align-center",
            Alignment.Right => "chord-align-right",
            _ => "chord-align-left"
        };
    }

    private async Task GoBack()
    {
        await JsRt.InvokeVoidAsync("goBack");
    }

    private void ShowSuccessMessage(string message)
    {
        _modalService.Show(new ModalOptionDto
        {
            Title = "Success",
            Message = message,
            ButtonText = "OK",
            OptionType = OptionType.Success
        });
    }

    private void ShowErrorMessage(string message)
    {
        _modalService.Show(new ModalOptionDto
        {
            Title = "Error",
            Message = message,
            ButtonText = "OK",
            OptionType = OptionType.Error
        });
    }

    private async Task ConfirmModal()
    {
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }

    public void Dispose()
    {
        chordScale = null;
        originalChords = null;
        autoScrollTimer?.Dispose();
        popoverTimer?.Dispose();
    }
}