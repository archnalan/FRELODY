@page "/compose"
@using Microsoft.AspNetCore.WebUtilities
@implements IDisposable
@inject ILogger<SongBoard> _logger

<div class="w-100 d-flex flex-column justify-content-center"
     style="max-width: 65rem;justify-self: center;">
	<h3 class="fw-bold text-center mb-3">Song Editor</h3>
    @if (isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row row-cols-lg-12 g-2 align-items-center">
            <!-- Input 1 -->
            <div class="col-3 col-md-2">
                <input type="number"
                       @bind="FormattedSongNumber"
                       class="form-control"
                       placeholder="Song #"
                       min="1" />
            </div>

            <!-- Input 2 -->
            <div class="col-9 col-md-4">
                <input type="text"
                       @bind="SongTitle"
                       class="form-control"
                       placeholder="Song Title" />
            </div>

            <!-- Dropdown -->
            <div class="col-9 col-md-4">
                @if (string.IsNullOrEmpty(selectedSongBook?.Id))
                {
                    <SongBookDropdown @ref="songBookDropdownRef"
                                      SelectedSongBook="selectedSongBook"
                                      SelectedSongBookChanged="HandleSongBookChanged" />

                }
                else if(selectedSongBook != null && !string.IsNullOrEmpty(selectedSongBook.Id))
                {
                    <div class="w-100 row">
                        <div class="col-4 btn btn-link text-decoration-none" 
                             @onclick="ChangeBookSelection">
                            <strong class="text-sm-start">
                                @(selectedSongBook.Title.Length > MAX_TITLE_LEN
                                                        ? selectedSongBook.Title.Substring(0, 15) + "…"
                                                        : selectedSongBook.Title)
                            </strong>
                        </div>
                        <div class="col-8">
                            <CategoriesDropdown SelectedCategory="@selectedCategory"
                                                SelectedCategoryChanged="HandleCategoryChanged"
                                                SongBookId="@selectedSongBook.Id"
                                                TabIndex="10" />
                        </div>
                       
                    </div>
                }
            </div>

            <!-- Save Button -->
            <div class="col-3 col-md-2 d-grid">
                <button type="button" 
                        class="btn btn-outline-primary"
                        @onclick="HandleSongSave" >
                    <span class="me-2 d-none d-md-inline">Save Song</span>
                    <i class="bi bi-clipboard-check"></i>
                </button>
            </div>
        </div>

        @if (initialPartsItems.Any())
        {
            <TabsComponent @ref="TabsComponentRef"
                           InitialItems="initialPartsItems"
                           ItemsCountLimit="MAX_SECTIONS"
                           OnTabAdd="HandleTabAdd"
                           RenderTab="RenderVerseTab"
                           OnTabSort="HandleTabSort"
                           ActiveTabInfoChanged ="HandleActiveTabInfoChanged"/>
        }
        else
        {
            <div class="alert alert-warning">
                No sections found. Click '+' to add a new section.
            </div>
        }
    }
    
</div>
<DialogModal IsVisible="@_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    [Parameter]
    public string? SongId { get; set; }
    const int MAX_SECTIONS = 25;
    private string SongTitle = "My New Song";
    private int SongNumber = 1;   
    private Dictionary<int, List<SegmentCreateDto>> AllPartsSegments =
    new() { [1] = new List<SegmentCreateDto>() };
    private List<TabsComponent.TabsComponentItem> initialPartsItems = new();
    private TabsComponent.TabsComponentItem? activeTabItem;
    private SongBookDto? selectedSongBook = null;
    private CategoryDto? selectedCategory = null; 
    private SimpleSongCreateDto songData = new();
    private SongBookDropdown? songBookDropdownRef;
    private TabsComponent? TabsComponentRef;
    private const int MAX_TITLE_LEN = 15;
    private bool isLoading = true;
    private Dictionary<int, SongSectionBoard> sectionBoardRefs = new();

    private RenderFragment RenderVerseTab(int id) => @<SongSectionBoard @ref="sectionBoardRefs[id]" SectionId="@id"
                  Segments="@AllPartsSegments.GetValueOrDefault(id, new List<SegmentCreateDto>())"
                  ActiveTab="activeTabItem" 
                  AllTabs="initialPartsItems"
                  OnSegmentsUpdate="segments => HandleVerseUpdate(id, segments)" />
    ;
    private string FormattedSongNumber
    {
        get => SongNumber.ToString("D3");
        set
        {
            if (int.TryParse(value, out var num))
            {
                SongNumber = num;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var uri = _navManager.ToAbsoluteUri(_navManager.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);
            if (query.TryGetValue("songId", out var songIdValues))
            {
                SongId = songIdValues.FirstOrDefault();
            }
            if (string.IsNullOrEmpty(SongId))
            {
                // Initialize new song
                initialPartsItems = new List<TabsComponent.TabsComponentItem>
                {
                    new TabsComponent.TabsComponentItem
                    {
                        Id = 1,
                        SectionName = nameof(SongSection.Verse),
                        SectionNumber = 1,
                        Content = builder =>
                        {
                            builder.OpenComponent<SongSectionBoard>(0);
                            builder.AddAttribute(1, "SectionId", 1);
                            builder.AddAttribute(2, "OnSegmentsUpdate",
                                EventCallback.Factory.Create<List<SegmentCreateDto>>(
                                    this, segments => HandleVerseUpdate(1, segments)));
                            builder.AddAttribute(3, "Segments", AllPartsSegments[1]);
                            builder.AddAttribute(4, "ActiveTab", activeTabItem);
                            builder.CloseComponent();
                        }
                    }
                };
                AllPartsSegments[1] = new List<SegmentCreateDto>();
            }
            else
            {
                var response = await _songsApi.GetSongWithChordsById(SongId);
                if (response.IsSuccessStatusCode)
                {
                    var song = response.Content!;
                    SongTitle = song.Title;
                    SongNumber = song.SongNumber ?? 0;
                    initialPartsItems = new List<TabsComponent.TabsComponentItem>();
                    AllPartsSegments = new Dictionary<int, List<SegmentCreateDto>>();

                    // Process parts
                    foreach (var part in song.SongParts!.OrderBy(v => v.PartNumber))
                    {
                        var verseSegments = new List<SegmentCreateDto>();
                        foreach (var line in part.LyricLines!.OrderBy(ll => ll.LyricLineOrder))
                        {
                            foreach (var segment in line.LyricSegments!.OrderBy(ls => ls.LyricOrder))
                            {
                                verseSegments.Add(new SegmentCreateDto
                                    {
                                        Id = segment.Id.ToString(),
                                        Lyric = segment.Lyric,
                                        ChordId = segment.ChordId?.ToString(),
                                        ChordName = segment.Chord?.ChordName,
                                        ChordAlignment = segment.ChordAlignment,
                                        LineNumber = line.LyricLineOrder,
                                        PartNumber = part.PartNumber,
                                        PartName = part.PartName ?? SongSection.Verse,
                                        LyricOrder = segment.LyricOrder
                                    });
                            }
                        }

                        AllPartsSegments[part.PartNumber] = verseSegments;

                        initialPartsItems.Add(new TabsComponent.TabsComponentItem
                            {
                                Id = part.PartNumber,
                                SectionName = part.PartName.ToString() ?? nameof(SongSection.Verse),
                                SectionNumber = part.PartNumber,
                                Content = builder =>
                                {
                                    builder.OpenComponent<SongSectionBoard>(0);
                                    builder.AddAttribute(1, "SectionId", part.PartNumber);
                                    builder.AddAttribute(2, "OnSegmentsUpdate",
                                        EventCallback.Factory.Create<List<SegmentCreateDto>>(
                                            this, segments => HandleVerseUpdate(part.PartNumber, segments)));
                                    builder.AddAttribute(3, "Segments", AllPartsSegments[part.PartNumber]);
                                    builder.AddAttribute(4, "ActiveTab", activeTabItem);
                                    builder.CloseComponent();
                                }
                            });
                    }
                }
                else
                {
                    var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                    _modalService.Show(new ModalOptionDto
                    {
                        Title = "Error",
                        Message = errorMessage,
                        ButtonText = "Close",
                        OptionType = OptionType.Error,
                        Context = new ModalContext
                        {
                            ActionType = "SongLoadError",
                            Data = response.Content?.ToString() ?? "No content"
                        }
                    });
                }
            }
            _tabsManager.OnRelocateLine += HandleRelocateLineRequest;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error initializing song board");
            _modalService.Show(new ModalOptionDto
            {
                Title = "Initialization Error",
                Message = "An error occurred while initializing the song board. Please try again later.",
                ButtonText = "Close",
                OptionType = OptionType.Error,
                Context = new ModalContext
                {
                    ActionType = "InitializationError",
                    Data = ex.Message
                }
            });            
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }

    }

    private async Task HandleSongSave()
    {
        var allSegments = AllPartsSegments.Values.SelectMany(v => v).ToList();

        songData.Title = SongTitle;
        songData.SongNumber = SongNumber;
        songData.SongLyrics = allSegments;

        if (allSegments.Count == 0)
        {
            _modalService.Show(new ModalOptionDto
            {
                Title = "No Segments",
                Message = "Please add at least one segment to save the song.",
                ButtonText = "OK",
                OptionType = OptionType.Warning,
                Context = new ModalContext
                {
                    ActionType = "NoSegments",
                    Data = "Attempted to save song with no segments"
                }
            });

            _logger.LogWarning("No segments found to save.");
            return;
        }

        Refit.IApiResponse<SongDto> songResult;
        if (string.IsNullOrEmpty(SongId) || SongId == "new")
        {
            SongId = null;
            songResult = await _songsApi.CreateSong(songData);
        }
        else
        {
            songResult = await _songsApi.UpdateSong(SongId, songData);
        }

        if (songResult.IsSuccessStatusCode)
        {
            _modalService.Show(new ModalOptionDto
            {
                Title = "Song Saved",
                Message = $"Song '{SongTitle}' saved successfully!",
                ButtonText = "OK",
                OptionType = OptionType.Success,
                Context = new ModalContext
                {
                    ActionType = "SongSaved",
                    Data = songResult.Content?.ToString() ?? "No content"
                }
            });

            _logger.LogInformation("Song {songData} saved successfully!", songData);
        }
        else
        {
            var errorMessage = _apiResponseHandler.GetApiErrorMessage(songResult);
            _modalService.Show(new ModalOptionDto
            {
                Title = "Save Error",
                Message = errorMessage,
                ButtonText = "Close",
                OptionType = OptionType.Error,
                Context = new ModalContext
                {
                    ActionType = "SongSaveError",
                    Data = songResult.Content?.ToString() ?? "No content"
                }
            });

            _logger.LogError("Failed to save song: {Error}", errorMessage);
        }
    }

    private void HandleActiveTabInfoChanged(TabsComponent.TabsComponentItem tabItem)
    {
        activeTabItem = tabItem;

        if (AllPartsSegments.TryGetValue(tabItem.Id, out var segments))
        {
            foreach (var segment in segments)
            {
                segment.PartNumber = tabItem.SectionNumber;
                segment.PartName = tabItem.SectionEnumValue;
            }
        }
        StateHasChanged();
    }

    private void HandleVerseUpdate(int sectionId, List<SegmentCreateDto> segments)
    {
        AllPartsSegments[sectionId] = segments;
    }

    private void HandleTabAdd(int newTabId)
    {
        if (!AllPartsSegments.ContainsKey(newTabId))
        {
            AllPartsSegments[newTabId] = new List<SegmentCreateDto>();
            if(TabsComponentRef != null)
            {
                initialPartsItems = TabsComponentRef.Items; //syncing items data
            }
        }
    }

    private void HandleTabSort(List<TabsComponent.TabsComponentItem> sortedItems)
    {
        // Create new segments dictionary preserving the content but updating positions
        var newAllPartsSegments = new Dictionary<int, List<SegmentCreateDto>>();

        // Copy segments to their new positions and update part numbers
        for (int i = 0; i < sortedItems.Count; i++)
        {
            var tab = sortedItems[i];
            var newPartNumber = i + 1; // Position-based part number (1, 2, 3, etc.)

            if (AllPartsSegments.TryGetValue(tab.Id, out var segments))
            {
                // Create a copy of segments and update their part numbers to match new position
                var updatedSegments = segments.Select(segment => new SegmentCreateDto
                {
                    Id = segment.Id,
                    Lyric = segment.Lyric,
                    ChordId = segment.ChordId,
                    ChordName = segment.ChordName,
                    LineNumber = segment.LineNumber,
                    PartNumber = newPartNumber, // Use position-based numbering
                    PartName = tab.SectionEnumValue,
                    LyricOrder = segment.LyricOrder,
                    AddNextSegment = segment.AddNextSegment,
                    ChordAlignment = segment.ChordAlignment
                }).ToList();

                newAllPartsSegments[tab.Id] = updatedSegments;
            }
            else
            {
                // Create empty list for new tabs
                newAllPartsSegments[tab.Id] = new List<SegmentCreateDto>();
            }
        }

        AllPartsSegments = newAllPartsSegments;

        // Force re-render of the tabs content by triggering StateHasChanged
        StateHasChanged();
    }

    private async Task HandleSongBookChanged(SongBookDto? newSongBook)
    {
        selectedSongBook = newSongBook;
        songData.SongBookId = newSongBook?.Id;
        // Reset selected category when song book changes
        selectedCategory = null;
        songData.CategoryId = null;

        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleCategoryChanged(CategoryDto? newCategory)
    {
        selectedCategory = newCategory;
        songData.CategoryId = newCategory?.Id;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleRelocateLineRequest(RelocateLineActionDto relocateArgs)
    {
        // source part that contains the line to be moved
        var sourcePartId = AllPartsSegments
            .Where(kvp => kvp.Value.Any(s => s.LineNumber == relocateArgs.CurrentLine))
            .Select(kvp => kvp.Key)
            .FirstOrDefault();

        if (sourcePartId == 0) return;

        var sourceSegments = AllPartsSegments[sourcePartId]
            .Where(s => s.LineNumber == relocateArgs.CurrentLine)
            .ToList();

        if (!sourceSegments.Any()) return;

        if (relocateArgs.CreateNewPart)
        {
            if (TabsComponentRef != null)
            {
                if (TabsComponentRef.Items.Count >= MAX_SECTIONS)
                {
                    _modalService.Show(new ModalOptionDto
                    {
                        Title = "Maximum Sections Reached",
                        Message = $"Cannot create new section. Maximum of {MAX_SECTIONS} sections allowed.",
                        ButtonText = "OK",
                        OptionType = OptionType.Warning
                    });
                    return;
                }
                try
                {
                    TabsComponentRef.HandleAddTab();

                    var newTabId = TabsComponentRef.Items.Max(i => i.Id);
                    var newTab = TabsComponentRef.Items.FirstOrDefault(item => item.Id == newTabId);

                    if (newTab != null && AllPartsSegments.ContainsKey(newTabId))
                    {
                        AllPartsSegments[sourcePartId].RemoveAll(s => s.LineNumber == relocateArgs.CurrentLine);
                        await _tabsManager.RemoveEmptyLine(sourcePartId, relocateArgs.CurrentLine);

                        // Renumber remaining segments in source part
                        var allRemainingSegments = AllPartsSegments[sourcePartId]
                            .OrderBy(s => s.LineNumber)
                            .ToList();

                        for (int i = 0; i < allRemainingSegments.Count; i++)
                        {
                            allRemainingSegments[i].LineNumber = i + 1;
                        }

                        // Update segments for new part
                        foreach (var segment in sourceSegments)
                        {
                            segment.PartNumber = newTab.SectionNumber;
                            segment.PartName = newTab.SectionEnumValue;
                            segment.LineNumber = 1; // Reset to line 1 in new part
                        }

                        // Replace the empty segments list with our relocated segments
                        AllPartsSegments[newTabId] = sourceSegments;

                        // Set the new tab as active
                        activeTabItem = newTab;
                    }
                    else
                    {
                        _modalService.Show(new ModalOptionDto
                        {
                            Title = "Tab Creation Failed",
                            Message = "Failed to create new section. Please try again.",
                            ButtonText = "OK",
                            OptionType = OptionType.Error
                        });
                        return;
                    }
                }
                catch (Exception ex)
                {
                    // FAILURE: Exception during tab creation, segments remain intact
                    _logger.LogError(ex, "Error creating new tab during line relocation");
                    _modalService.Show(new ModalOptionDto
                    {
                        Title = "Error",
                        Message = "An error occurred while creating the new section.",
                        ButtonText = "OK",
                        OptionType = OptionType.Error
                    });
                    return;
                }
        }
        }
        else if (relocateArgs.TargetPart != null)
        {
            // Move to existing part
            var targetPartId = relocateArgs.TargetPart.Id;
            if (TabsComponentRef!=null && !TabsComponentRef.Items.Any(item => item.Id == targetPartId))
            {
                _modalService.Show(new ModalOptionDto
                {
                    Title = "Target Section Not Found",
                    Message = "The target section no longer exists. Please try again.",
                    ButtonText = "OK",
                    OptionType = OptionType.Error
                });
                return;
            }
            try
            {
                if (!AllPartsSegments.ContainsKey(targetPartId))
                {
                    AllPartsSegments[targetPartId] = new List<SegmentCreateDto>();
                }

                // Find the next available line number in target part
                var targetSegments = AllPartsSegments[targetPartId];
                var maxLineInTarget = targetSegments.Any()
                    ? targetSegments.Max(s => s.LineNumber)
                    : 0;

                // SUCCESS: Remove source segments
                AllPartsSegments[sourcePartId].RemoveAll(s => s.LineNumber == relocateArgs.CurrentLine);
                await _tabsManager.RemoveEmptyLine(sourcePartId, relocateArgs.CurrentLine);

                // Renumber remaining segments in source part
                var allRemainingSegments = AllPartsSegments[sourcePartId]
                    .OrderBy(s => s.LineNumber)
                    .ToList();

                for (int i = 0; i < allRemainingSegments.Count; i++)
                {
                    allRemainingSegments[i].LineNumber = i + 1;
                }

                // Update segments for target part
                foreach (var segment in sourceSegments)
                {
                    segment.PartNumber = relocateArgs.TargetPart.SectionNumber;
                    segment.PartName = relocateArgs.TargetPart.SectionEnumValue;
                    segment.LineNumber = maxLineInTarget + 1;
                }

                AllPartsSegments[targetPartId].AddRange(sourceSegments);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error moving segments to target part");
                _modalService.Show(new ModalOptionDto
                {
                    Title = "Error",
                    Message = "An error occurred while moving the line to the target section.",
                    ButtonText = "OK",
                    OptionType = OptionType.Error
                });
                return;
            }
        }
        StateHasChanged();
    }

    private async void ChangeBookSelection()
    {
        selectedSongBook = null;
        selectedCategory = null;
        songData.SongBookId = null;
        songData.CategoryId = null;
        StateHasChanged();

        if (songBookDropdownRef != null)
        {
            await songBookDropdownRef.FocusInput();
        }
    }

    private async Task ConfirmModal()
    {
        // handle specific contexts awaiting confirmation
        if (_modalService.CurrentModal.Context?.ActionType == "SongSaved")
        {
            _modalService.Close();
            _navManager.NavigateTo("/songs-list");
        }
        await CloseModal();
    }
    private async Task CloseModal()
    {
        _modalService.Close();
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        _tabsManager.OnRelocateLine -= HandleRelocateLineRequest;
    }
}