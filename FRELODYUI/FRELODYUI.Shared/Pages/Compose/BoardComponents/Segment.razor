@using FRELODYUI.Shared.Pages.Compose.ChordComponents
@inject ILogger<Segment> _logger

<div class="@($"h-100 w-100 d-flex align-items-between py-3 px-2 rounded cursor-pointer {(FocusedLine ? "bg-dark" : "bg-secondary")}")">
    @if (Editing)
    {
        <AddSegment @ref="addSegmentRef"
                    @bind-SelectedChord="selectedChord"
                    @bind-FormOpen="Editing"
                    IsMidSegments="true"
                    SegmentText="@Content.Lyric"
                    OnCancel= "HandleCancel"
                    OnSegmentAdded="HandleSegmentEdited"/>
    }
    else
    {
        <div class="d-flex flex-column justify-content-between" style="@TextBoxSize">
            <div>
                <p class="small text-white m-0">@ChordName</p>
            </div>
            <div>
                <p class="small text-white m-0">@Content.Lyric</p>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public SegmentCreateDto Content { get; set; } = default!;
    [Parameter] public bool Editing { get; set; }
    [Parameter] public bool FocusedLine { get; set; }
    [Parameter] public string TextBoxSize { get; set; } = "width:8rem;"; 
    [Parameter] public EventCallback<SegmentCreateDto> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<SegmentCreateDto> OnDragStart { get; set; }
    [Parameter] public EventCallback<SegmentCreateDto> SegmentRemoved { get; set; }

    private ChordDto selectedChord = new();
    private string ChordName = string.Empty;
    private bool isInitialized = false;
    private AddSegment addSegmentRef = default!;

    protected async override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if(!isInitialized)
            {
                if (!string.IsNullOrEmpty(Content.Id))
                {
                    ChordName = Content.ChordName ?? string.Empty;
                    if (string.IsNullOrEmpty(ChordName)
                    && !string.IsNullOrEmpty(Content.ChordId))
                    {
                        selectedChord = await GetChord(Content.ChordId);
                    }
                }
                isInitialized = true;
                StateHasChanged();
            }
        }
    }

    private async Task HandleDragStart()
    {
        await OnDragStart.InvokeAsync(Content);
    }

    private void HandleCancel()
    {
        Editing = false; 
        if(string.IsNullOrEmpty(Content.ChordName) 
        && string.IsNullOrEmpty(Content.Lyric))
        {
            if(SegmentRemoved.HasDelegate)
                SegmentRemoved.InvokeAsync(Content);
        }
    }

    private void HandleSegmentEdited(SegmentCreateDto editedSegment)
    {
        if (editedSegment != null)
        {
            // Update the current Content with the edited values
            Content.Lyric = editedSegment.Lyric;
            Content.ChordId = editedSegment.ChordId;
            Content.ChordName = editedSegment.ChordName;
            Content.AddNextSegment = editedSegment.AddNextSegment;

            // Update the local ChordName for display
            ChordName = editedSegment.ChordName ?? string.Empty;
        }
        // Notify parent that save is complete
        OnSave.InvokeAsync(Content);

    }

    public void SetSelectedChord(ChordDto chord)
    {
        selectedChord = chord;
        Content.ChordId = chord.Id;
        Content.ChordName = chord.ChordName;
        ChordName = chord.ChordName ?? string.Empty;
        StateHasChanged();
    }

    public async Task<ChordDto> GetChord(string chordId)
    {
        try
        {            
            var response = await _chordsApi.GetChordById(chordId);
            if (response.IsSuccessStatusCode)
            {
                return response.Content!;
            }
            else
            {
                var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                _logger.LogError("Error getting chord: {Error}", errorMessage);
                return new ChordDto();
            }
        }
        catch (Exception ex)
        {
            _logger.LogError("Error getting chord: {Error}", ex);
            return new ChordDto();
        }
    }

    public void HandleEditedAndExit()
    {
        if (addSegmentRef != null && addSegmentRef.FormOpen)
        {
            addSegmentRef.SubmitAndExit();
        }
    }

}