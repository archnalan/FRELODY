@page "/chord-charts/create/{chordId}"
@page "/chord-charts/edit/{Id}"
@using FRELODYUI.Shared.Pages.Compose.ChordComponents
@using FRELODYUI.Shared.Pages.ChordCharts.Steps
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using Refit
@using System.Text.Json
@inject ILogger<ChordChartCreate> _logger
@implements IDisposable

<div class="wizard-container">
    <div class="wizard-card">
        <!-- Header with Back Button and Title -->
        <div class="wizard-header">
            <button class="back-button" @onclick="GoBack" type="button">
                <i class="bi bi-arrow-left"></i>
                <span>Back</span>
            </button>
            <div class="wizard-header-content">
                <h2 class="wizard-title">@HeaderText Chord Chart</h2>
                <p class="wizard-subtitle">Follow the steps to create your custom chord chart</p>
            </div>
        </div>

        <!-- Step Progress Indicator -->
        <div class="wizard-progress">
            <div class="progress-steps">
                @for (int i = 1; i <= TotalSteps; i++)
                {
                    int stepNumber = i;
                    <div class="progress-step @(CurrentStep == stepNumber ? "active" : "") @(CurrentStep > stepNumber ? "completed" : "")"
                         @onclick="@(() => { if (CanNavigateToStep(stepNumber)) NavigateToStep(stepNumber); })">
                        <div class="step-circle">
                            @if (CurrentStep > stepNumber)
                            {
                                <i class="bi bi-check"></i>
                            }
                            else
                            {
                                <span>@stepNumber</span>
                            }
                        </div>
                        <div class="step-info">
                            <span class="step-label">@GetStepLabel(stepNumber)</span>
                        </div>
                        @if (stepNumber < TotalSteps)
                        {
                            <div class="step-connector"></div>
                        }
                    </div>
                }
            </div>
        </div>

        <EditForm Model="@FormModel" OnValidSubmit="@HandleValidSubmit" FormName="chartForm" class="wizard-form">
            <DataAnnotationsValidator />
            
            <!-- Validation Summary -->
            @if (HasValidationErrors)
            {
                <div class="validation-summary-container">
                    <div class="validation-summary-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="validation-summary-content">
                        <ValidationSummary />
                    </div>
                </div>
            }

            <!-- Wizard Steps Container -->
            <div class="wizard-steps-container">
                <div class="wizard-step @GetStepClass(1)" @key="1">
                    @if (CurrentStep == 1)
                    {
                        <ChordStepDetails FormModel="@FormModel"
                                        Chords="@Chords"
                                        SelectedChord="@SelectedChord"
                                        OpenCreateChordModal="@OpenCreateChordModal" />
                    }
                </div>

                <div class="wizard-step @GetStepClass(2)" @key="2">
                    @if (CurrentStep == 2)
                    {
                        <ChordStepMedia ChartPreview="@ChartPreview"
                                      AudioPreview="@AudioPreview"
                                      IsUploadingChart="@IsUploadingChart"
                                      IsUploadingAudio="@IsUploadingAudio"
                                      ChartUploadError="@ChartUploadError"
                                      AudioUploadError="@AudioUploadError"
                                      OnChartUpload="@HandleChartUpload"
                                      OnAudioUpload="@HandleAudioUpload"
                                      OnClearChart="@ClearChartFile"
                                      OnClearAudio="@ClearAudioFile" />
                    }
                </div>

                <div class="wizard-step @GetStepClass(3)" @key="3">
                    @if (CurrentStep == 3)
                    {
                        <ChordStepNotes FormModel="@FormModel" />
                    }
                </div>

                <div class="wizard-step @GetStepClass(4)" @key="4">
                    @if (CurrentStep == 4)
                    {
                        <ChordStepReview FormModel="@FormModel"
                                       SelectedChord="@SelectedChord"
                                       ChartPreview="@ChartPreview"
                                       AudioPreview="@AudioPreview"
                                       JumpToStep="@NavigateToStep" />
                    }
                </div>
            </div>

            <!-- Wizard Navigation Footer -->
            <div class="wizard-footer">
                @if (CurrentStep > 1)
                {
                    <button type="button" 
                          class="btn-secondary wizard-btn-back" 
                          @onclick="PreviousStep"
                          disabled="@IsSubmitting">
                        <i class="bi bi-arrow-left"></i>
                        <span>Back</span>
                    </button>
                }
                else
                {
                    <button type="button" 
                          class="btn-secondary wizard-btn-back" 
                          @onclick="GoBack"
                          disabled="@IsSubmitting">
                        <i class="bi bi-x-circle"></i>
                        <span>Cancel</span>
                    </button>
                }

                @if (CurrentStep < TotalSteps)
                {
                    <button type="button" 
                          class="btn-primary wizard-btn-next" 
                          @onclick="NextStep"
                          disabled="@(!CanProceedToNextStep() || IsUploadingChart || IsUploadingAudio)">
                        <span>Continue</span>
                        <i class="bi bi-arrow-right"></i>
                    </button>
                }
                else
                {
                    <button type="submit" 
                          class="btn-primary wizard-btn-submit" 
                          disabled="@(IsSubmitting || IsUploadingChart || IsUploadingAudio || !IsFormValid())">
                        @if (IsSubmitting)
                        {
                            <i class="spinner-border spinner-border-sm"></i>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-circle"></i>
                            <span>Save Chord Chart</span>
                        }
                    </button>
                }
            </div>

            <!-- Global Error Message -->
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="error-alert">
                    <div class="error-alert-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div class="error-alert-content">
                        <strong>Error</strong>
                        <p>@ErrorMessage</p>
                    </div>
                </div>
            }
        </EditForm>
    </div>
</div>

@if (showCustomizeModal)
{
    <ChordCustomize Show="showCustomizeModal"
                    Content="SelectedChord"
                    OnSave="HandleChordSaved" 
                    OnCancel="CloseCustomizeModal" />
}

<DialogModal IsVisible="@_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    [Parameter] public string? chordId { get; set; }
    [Parameter] public string? Id { get; set; }
    private string? ApiBaseUrl = "https://localhost:7077";

    // Form Data
    private ChordChartDto FormModel = new();
    private List<ChordDto> Chords = new List<ChordDto>();
    private ChordDto SelectedChord = new();
    private string HeaderText = "Create";
    private string ChartPreview = "";
    private string AudioPreview = "";
    private bool IsSubmitting = false;
    private bool IsUploadingChart = false;
    private bool IsUploadingAudio = false;
    private string ErrorMessage = "";
    private StreamPart? ChartStream;
    private string ChartUploadError = "";
    private StreamPart? AudioStream;
    private string AudioUploadError = "";
    private bool showDropdown = false;
    private bool showCustomizeModal = false;
    private bool HasValidationErrors = false;

    // Wizard Navigation State
    private int CurrentStep = 1;
    private readonly int TotalSteps = 4;
    private HashSet<int> CompletedSteps = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadChords();

        if (!string.IsNullOrEmpty(Id))
        {
            await LoadChartForEdit(Id);
            HeaderText = "Edit";
        }
        else if (!string.IsNullOrEmpty(chordId))
        {
            SelectedChord = Chords.FirstOrDefault(c => c.Id == chordId) ?? new ChordDto();
            FormModel.ChordId = SelectedChord.Id;
        }
        FormModel.FretPosition = 1;
    }

    private void NextStep()
    {
        if (CurrentStep < TotalSteps && CanProceedToNextStep())
        {
            CompletedSteps.Add(CurrentStep);
            CurrentStep++;
            ErrorMessage = "";
            StateHasChanged();
        }
    }

    private void PreviousStep()
    {
        if (CurrentStep > 1)
        {
            CurrentStep--;
            ErrorMessage = "";
            StateHasChanged();
        }
    }

    private void NavigateToStep(int step)
    {
        if (step >= 1 && step <= TotalSteps && CanNavigateToStep(step))
        {
            CurrentStep = step;
            ErrorMessage = "";
            StateHasChanged();
        }
    }

    private bool CanNavigateToStep(int step)
    {
        if (step < CurrentStep)
            return true;

        for (int i = 1; i < step; i++)
        {
            if (!IsStepValid(i))
                return false;
        }

        return true;
    }

    private bool CanProceedToNextStep()
    {
        return IsStepValid(CurrentStep);
    }

    private bool IsStepValid(int step)
    {
        return step switch
        {
            1 => !string.IsNullOrEmpty(FormModel.ChordId),
            2 => !string.IsNullOrEmpty(ChartPreview),
            3 => true,
            4 => true,
            _ => false
        };
    }

    private bool IsFormValid()
    {
        return !string.IsNullOrEmpty(FormModel.ChordId) && 
               !string.IsNullOrEmpty(ChartPreview);
    }

    private string GetStepClass(int step)
    {
        if (CurrentStep == step)
            return "wizard-step-active";
        else if (CurrentStep > step)
            return "wizard-step-completed";
        else
            return "wizard-step-upcoming";
    }

    private string GetStepLabel(int step)
    {
        return step switch
        {
            1 => "Chord",
            2 => "Media",
            3 => "Notes",
            4 => "Review",
            _ => ""
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRt.InvokeVoidAsync("eval", @"
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        const nextBtn = document.querySelector('.wizard-btn-next, .wizard-btn-submit');
                        if (nextBtn && !nextBtn.disabled) nextBtn.click();
                    } else if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        const backBtn = document.querySelector('.wizard-btn-back');
                        if (backBtn && !backBtn.disabled) backBtn.click();
                    }
                });
            ");
        }
    }

    private async Task LoadChords()
    {
        try
        {
            var response = await _chordsApi.GetChords();
            if (response.IsSuccessStatusCode)
            {
                Chords = response.Content?.Data!;
            }
            else
            {
                ErrorMessage = "Failed to load chords";
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading chords");
            ErrorMessage = "Failed to load chords";
        }
    }

    private async Task LoadChartForEdit(string chartId)
    {
        try
        {
            var response = await _chordChartsApi.GetChordChartById(chartId.ToString());

            if (response.IsSuccessStatusCode && response.Content != null)
            {
                var chart = response.Content;
                FormModel.Id = chart.Id;
                FormModel.ChordId = chart.ChordId;
                FormModel.FretPosition = chart.FretPosition ?? 1;
                FormModel.PositionDescription = chart.PositionDescription;
                FormModel.FilePath = chart.FilePath;
                FormModel.ChartAudioFilePath = chart.ChartAudioFilePath;

                if (!string.IsNullOrEmpty(chart.FilePath))
                {
                    ChartPreview = DisplayChart(chart.FilePath);
                }

                if (!string.IsNullOrEmpty(chart.ChartAudioFilePath))
                {
                    AudioPreview = chart.ChartAudioFilePath;
                }

                SelectedChord = Chords.FirstOrDefault(c => c.Id == chart.ChordId) ?? new ChordDto();
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading chart for edit");
            ErrorMessage = "Failed to load chart data";
        }
    }

    private async Task HandleChartUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        IsUploadingChart = true;
        ClearChartFile();

        try
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            ChartPreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            FormModel.FilePath = file.Name;
            ChartStream = new StreamPart(new MemoryStream(buffer), file.Name, file.ContentType);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error uploading chart image");
            ChartUploadError = "Error uploading chart image. Please try again.";
            ClearChartFile();
        }
        finally
        {
            IsUploadingChart = false;
            StateHasChanged();
        }
    }

    private async Task HandleAudioUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        IsUploadingAudio = true;
        AudioUploadError = "";

        try
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024).ReadAsync(buffer);
            AudioPreview = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            AudioStream = new StreamPart(new MemoryStream(buffer), file.Name, file.ContentType);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error uploading audio file");
            AudioUploadError = "Error uploading audio file. Please try again.";
            ClearAudioFile();
        }
        finally
        {
            IsUploadingAudio = false;
            StateHasChanged();
        }
    }

    private string DisplayChart(string filePath)
    {
        if (string.IsNullOrEmpty(filePath))
            return "";
        if (filePath.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            return filePath;
        return $"{ApiBaseUrl}/{filePath.TrimStart('/')}";
    }

    private void ClearChartFile()
    {
        ChartPreview = "";
        FormModel.FilePath = "";
        ChartUploadError = "";
    }

    private void ClearAudioFile()
    {
        AudioPreview = "";
        FormModel.ChartAudioFilePath = "";
        AudioUploadError = "";
    }

    private async Task HandleValidSubmit()
    {
        IsSubmitting = true;
        ErrorMessage = "";
        HasValidationErrors = false;

        try
        {
            IApiResponse<ChordChartEditDto> response;

            if (!string.IsNullOrEmpty(FormModel.Id))
            {
                var editDto = new ChordChartEditDto
                {
                    Id = FormModel.Id,
                    ChordId = FormModel.ChordId,
                    FretPosition = FormModel.FretPosition,
                    PositionDescription = FormModel.PositionDescription,
                    FilePath = FormModel.FilePath,
                    ChartAudioFilePath = FormModel.ChartAudioFilePath
                };

                var chartDataJson = JsonSerializer.Serialize(editDto, new JsonSerializerOptions
                {
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                });

                response = await _chordChartsApi.UpdateChordChartFiles(
                    ChartStream,
                    AudioStream,
                    chartDataJson);
            }
            else
            {
                var createDto = new ChordChartCreateDto
                {
                    ChordId = FormModel.ChordId,
                    FretPosition = FormModel.FretPosition ?? 1,
                    PositionDescription = FormModel.PositionDescription
                };

                var chartDataJson = JsonSerializer.Serialize(createDto, new JsonSerializerOptions
                {
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                });

                response = await _chordChartsApi.CreateChordChartFiles(
                    ChartStream,
                    AudioStream,
                    chartDataJson);
            }

            if (response.IsSuccessStatusCode)
            {
                var chart = response.Content!;
                var successMessage = !string.IsNullOrEmpty(FormModel.Id)
                    ? $"Chord chart updated successfully"
                    : $"Chord chart created successfully";

                _navManager.NavigateTo($"/chords?success={Uri.EscapeDataString(successMessage)}");
            }
            else
            {
                var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                ErrorMessage = errorMessage ?? "An error occurred while saving the chart";
                HasValidationErrors = true;
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error submitting chart form");
            ErrorMessage = "An error occurred while saving the chart";
            HasValidationErrors = true;
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private void OpenCreateChordModal()
    {
        showCustomizeModal = true;
        showDropdown = false;
        SelectedChord.ChordName = SelectedChord.ChordName ?? "";
        StateHasChanged();
    }

    private void CloseCustomizeModal()
    {
        showCustomizeModal = false;
    }

    private async Task HandleChordSaved(ChordDto newChord)
    {
        newChord = Chords.FirstOrDefault(c =>
                   c.ChordName.Trim().ToLower() == newChord.ChordName.Trim().ToLower())
                   ?? newChord;
        if (!Chords.Any(c => c.Id == newChord.Id))
        {
            var chord = new ChordCreateDto
            {
                ChordName = newChord.ChordName,
                ChordType = ChordTypeService.DetermineChordType(newChord.ChordName),
            };
            var response = await _chordsApi.CreateChord(chord);
            if (!response.IsSuccessStatusCode)
            {
                var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                _modalService.Show(new ModalOptionDto
                {
                    Title = "Error",
                    Message = errorMessage,
                    ButtonText = "Close",
                    OptionType = OptionType.Error,
                    Context = new ModalContext
                    {
                        ActionType = "CreateChord",
                        Data = errorMessage
                    }
                });
                return;
            }
            Chords.Add(newChord);
        }

        SelectedChord = newChord;
        showDropdown = false;
        CloseCustomizeModal();
    }

    private async Task GoBack()
    {
        //_navManager.NavigateTo("/songs-list");
        await JsRt.InvokeVoidAsync("goBack");
    }

    private async Task ConfirmModal()
    {
        //Handle specific contexts
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}