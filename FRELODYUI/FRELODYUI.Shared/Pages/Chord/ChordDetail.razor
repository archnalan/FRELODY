@page "/chords/{Id}"
@using FRELODYUI.Shared.Pages.Compose.ChordComponents
@using Microsoft.AspNetCore.Components
@inject ILogger<ChordDetail> Logger

<div class="chord-detail-container">
    <div class="chord-detail-wrapper">
        <!-- Header Section -->
        <div class="detail-header">
            <button class="back-button" @onclick="NavigateBack">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div class="header-content">
                <h1 class="detail-title">Chord Details</h1>
                <p class="detail-subtitle">View and manage chord information</p>
            </div>
            <button class="action-button" @onclick="EditChord">
                <i class="bi bi-pencil"></i>
                <span>Edit Chord</span>
            </button>
        </div>

        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading chord details...</p>
            </div>
        }
        else if (chord != null)
        {
            <div class="detail-content">
                <!-- Chord Information Section -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <h2 class="detail-section-title">
                            <i class="bi bi-music-note-beamed"></i>
                            Chord Information
                        </h2>
                    </div>
                    <div class="detail-section-body">
                        <div class="detail-item">
                            <span class="detail-label">
                                <i class="bi bi-music-note"></i>
                                Chord Name
                            </span>
                            <span class="detail-value">@chord.ChordName</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">
                                <i class="bi bi-bar-chart-steps"></i>
                                Difficulty Level
                            </span>
                            <span class="detail-value difficulty-@GetDifficultyClass(chord.Difficulty ?? 0)">
                                @GetDifficultyText(chord.Difficulty ?? 0)
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">
                                <i class="bi bi-tag"></i>
                                Chord Type
                            </span>
                            <span class="detail-value">@GetChordTypeText(chord.ChordType)</span>
                        </div>
                    </div>
                </div>

                <!-- Chord Charts Section -->
                <div class="detail-section">
                    <div class="detail-section-header">
                        <h2 class="detail-section-title">
                            <i class="bi bi-grid-3x3"></i>
                            Chord Charts
                        </h2>
                        <button type="button" class="add-chart-button" @onclick="() => AddChart(chord.Id)">
                            <i class="bi bi-plus-circle"></i>
                            Add Chart
                        </button>
                    </div>
                    <div class="detail-section-body">
                        <div class="charts-container">
                            <ChordCarousel @ref="chordCarouselRef" Chord="@chord" />
                        </div>
                    </div>
                </div>

                <!-- Audio Section (if available) -->
                @if (!string.IsNullOrEmpty(chord.ChordAudioFilePath))
                {
                    <div class="detail-section">
                        <div class="detail-section-header">
                            <h2 class="detail-section-title">
                                <i class="bi bi-volume-up"></i>
                                Audio Sample
                            </h2>
                        </div>
                        <div class="detail-section-body">
                            <div class="audio-player-container">
                                <audio controls class="audio-player">
                                    <source src="@chord.ChordAudioFilePath" />
                                    Your browser does not support this audio format.
                                </audio>
                            </div>
                        </div>
                    </div>
                }

                <!-- Metadata Section -->
                <div class="detail-section metadata-section">
                    <div class="detail-section-header">
                        <h2 class="detail-section-title">
                            <i class="bi bi-info-circle"></i>
                            Metadata
                        </h2>
                    </div>
                    <div class="detail-section-body">
                        <div class="metadata-grid">
                            @if (chord.DateCreated.HasValue)
                            {
                                <div class="metadata-item">
                                    <i class="bi bi-calendar-plus"></i>
                                    <div class="metadata-content">
                                        <span class="metadata-label">Created</span>
                                        <span class="metadata-value">@chord.DateCreated.Value.ToString("MMM dd, yyyy")</span>
                                    </div>
                                </div>
                            }
                            @if (chord.DateModified.HasValue)
                            {
                                <div class="metadata-item">
                                    <i class="bi bi-calendar-check"></i>
                                    <div class="metadata-content">
                                        <span class="metadata-label">Modified</span>
                                        <span class="metadata-value">@chord.DateModified.Value.ToString("MMM dd, yyyy")</span>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(chord.Id))
                            {
                                <div class="metadata-item">
                                    <i class="bi bi-key"></i>
                                    <div class="metadata-content">
                                        <span class="metadata-label">Chord ID</span>
                                        <span class="metadata-value metadata-id">@chord.Id.Substring(0, Math.Min(8, chord.Id.Length))...</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="detail-actions">
                    <button class="btn-secondary" @onclick="NavigateBack">
                        <i class="bi bi-arrow-left"></i>
                        Back to List
                    </button>
                    <button class="btn-primary" @onclick="EditChord">
                        <i class="bi bi-pencil"></i>
                        Edit Chord
                    </button>
                </div>
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="bi bi-exclamation-circle"></i>
                <h3>Chord Not Found</h3>
                <p>The chord you're looking for doesn't exist or has been removed.</p>
                <button class="btn-primary" @onclick="NavigateBack">
                    <i class="bi bi-arrow-left"></i>
                    Return to Chords
                </button>
            </div>
        }
    </div>
</div>

@if (showChordModal)
{
    <ChordCustomize Show="showChordModal"
                    ModalHeaderText="@modalHeaderText" 
                    Content="chord"
                    OnSave="HandleChordSubmit" 
                    OnCancel="CloseChordModal" />
}

<DialogModal IsVisible="@_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    [Parameter]
    public string? Id { get; set; }

    private ChordDto? chord;
    private bool isLoading = true;
    private bool showChordModal = false;
    private string modalHeaderText = "Edit";
    private ChordCarousel? chordCarouselRef;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Id))
        {
            await LoadChordDetails(Id);
        }
        else
        {
            Logger.LogWarning("No chord ID provided");
            isLoading = false;
        }
    }

    private string GetDifficultyText(ChordDifficulty difficulty)
    {
        return difficulty switch
        {
            ChordDifficulty.Easy => "Beginner",
            ChordDifficulty.Medium => "Intermediate",
            ChordDifficulty.Advanced => "Advanced",
            ChordDifficulty.Expert => "Expert",
            _ => "Unknown"
        };
    }

    private string GetDifficultyClass(ChordDifficulty difficulty)
    {
        return difficulty switch
        {
            ChordDifficulty.Easy => "easy",
            ChordDifficulty.Medium => "medium",
            ChordDifficulty.Advanced => "advanced",
            ChordDifficulty.Expert => "expert",
            _ => "unknown"
        };
    }

    private string GetChordTypeText(ChordType? chordType)
    {
        if (!chordType.HasValue) return "Not specified";
        
        return chordType.Value switch
        {
            ChordType.Major => "Major",
            ChordType.Minor => "Minor",
            ChordType.Suspended => "Suspended",
            ChordType.Augmented => "Augmented",
            ChordType.Diminished => "Diminished",
            ChordType.Seventh => "Seventh",
            ChordType.MajorSeventh => "Major Seventh",
            ChordType.MinorSeventh => "Minor Seventh",
            _ => chordType.Value.ToString()
        };
    }

    private async Task LoadChordDetails(string chordId)
    {
        try
        {
            isLoading = true;
            var response = await _chordsApi.GetChordById(chordId);
            if (response.IsSuccessStatusCode)
            {
                chord = response.Content;
            }
            else
            {
                var errorMsg = _apiResponseHandler.GetApiErrorMessage(response);
                _modalService.Show(new ModalOptionDto
                {
                    Title = "Error",
                    Message = $"Failed to load chord details. {errorMsg}",
                    OptionType = OptionType.Error,
                    Context = new ModalContext { ActionType = "LoadChordDetails", Data = chordId }
                });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading chord details");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleChordSubmit(ChordDto submittedChord)
    {
        Refit.IApiResponse<ChordEditDto?> response;
        
        var editChord = new ChordEditDto
        {
            Id = submittedChord.Id,
            ChordName = submittedChord.ChordName,
            ChordType = ChordTypeService.DetermineChordType(submittedChord.ChordName),
            Difficulty = ChordTypeService.DetermineChordDifficulty(submittedChord.ChordName),
        };

        response = await _chordsApi.UpdateChord(editChord);

        if (!response.IsSuccessStatusCode)
        {
            var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
            _modalService.Show(new ModalOptionDto
            {
                Title = "Error",
                Message = errorMessage,
                ButtonText = "Close",
                OptionType = OptionType.Error,
                Context = new ModalContext
                {
                    ActionType = "UpdateChord",
                    Data = errorMessage
                }
            });
            return;
        }
        
        await LoadChordDetails(submittedChord.Id ?? "");
        if (chordCarouselRef != null) await chordCarouselRef.LoadCharts(submittedChord.Id ?? "");
        CloseChordModal();
    }

    private void CloseChordModal()
    {
        showChordModal = false;
    }

    private void NavigateBack()
    {
        _navManager.NavigateTo("/chords");
    }

    private void AddChart(string? chordId)
    {
        _navManager.NavigateTo($"/chord-charts/create/{chordId}");
    }

    private void EditChord()
    {
        modalHeaderText = "Edit";
        showChordModal = true;
    }

    private async Task ConfirmModal()
    {
        _modalService.Close();
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }
}