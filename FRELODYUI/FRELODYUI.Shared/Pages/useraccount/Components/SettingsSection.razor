@inject ILogger<SettingsSection> _logger

<div class="row">
    <div class="col-lg-8 mx-auto">
        @if (IsLoading)
        {
            <div class="d-flex justify-content-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading settings...</span>
                </div>
            </div>
        }
        else
        {
            <!-- Appearance Settings -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-palette me-2"></i>Appearance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" @bind="showNotification" role="switch" id="switchCheck">
                        <label class="form-check-label" for="switchCheck">Notify me about new songs and updates</label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Theme</label>
                            <select class="form-select" @bind="userSettings.Theme">
                                @foreach (var theme in Enum.GetValues<Theme>())
                                {
                                    <option value="@theme">@theme</option>
                                }
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Song Display Mode</label>
                            <select class="form-select" @bind="userSettings.SongDisplay">
                                @foreach (var display in Enum.GetValues<SongDisplay>())
                                {
                                    <option value="@display">@GetDisplayName(display)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chord Settings -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-music-note me-2"></i>Chord Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Chord Display</label>
                            <select class="form-select" @bind="userSettings.ChordDisplay">
                                @foreach (var display in Enum.GetValues<ChordDisplay>())
                                {
                                    <option value="@display">@GetChordDisplayName(display)</option>
                                }
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Preferred Difficulty</label>
                            <select class="form-select" @bind="userSettings.ChordDifficulty">
                                @foreach (var difficulty in Enum.GetValues<ChordDifficulty>())
                                {
                                    <option value="@difficulty">@GetDifficultyName(difficulty)</option>
                                }
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Play Level</label>
                            <select class="form-select" @bind="userSettings.PlayLevel">
                                @foreach (var level in Enum.GetValues<PlayLevel>())
                                {
                                    <option value="@level">@GetPlayLevelName(level)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Font Settings -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-fonts me-2"></i>Typography
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Chord Font</label>
                            <select class="form-select" @bind="userSettings.ChordFont">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Chord Font Size</label>
                            <select class="form-select" @bind="userSettings.ChordFontSize">
                                <option value="12">12px</option>
                                <option value="14">14px</option>
                                <option value="16">16px</option>
                                <option value="18">18px</option>
                                <option value="20">20px</option>
                                <option value="24">24px</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Lyric Font</label>
                            <select class="form-select" @bind="userSettings.LyricFont">
                                <option value="Arial">Arial</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Lyric Font Size</label>
                            <select class="form-select" @bind="userSettings.LyricFontSize">
                                <option value="14">14px</option>
                                <option value="16">16px</option>
                                <option value="18">18px</option>
                                <option value="20">20px</option>
                                <option value="22">22px</option>
                                <option value="24">24px</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="d-flex justify-content-end">
                <button class="btn btn-primary" @onclick="SaveUserSettings" disabled="@IsSaving">
                    @if (IsSaving)
                    {
                        <i class="spinner-border spinner-border-sm me-2"></i>
                    }
                    Save Settings
                </button>
            </div>
        }
    </div>
</div>
<!-- Modals -->
<DialogModal IsVisible="@_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    [Parameter] public string UserId { get; set; } = string.Empty;

    private SettingDto userSettings { get; set; } = new();
    private bool IsSaving { get; set; }
    private bool IsLoading { get; set; }
    private bool showNotification = false;
    private bool isLoadingSettings = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserSettings();
    }

    private async Task LoadUserSettings()
    {
        try
        {
            isLoadingSettings = true;
            var response = await _settingsApi.GetUserSettings(UserId);

            if (response.IsSuccessStatusCode && response.Content != null)
            {
                userSettings = response.Content;
                showNotification = userSettings.ShowNotifications ?? false;
            }
            else
            {
                // Create default settings if none exist
                userSettings = new SettingDto
                {
                    ChordFont = "Arial",
                    LyricFont = "Arial",
                    ChordFontSize = "14",
                    LyricFontSize = "16",
                    SongDisplay = SongDisplay.LyricsAndChords,
                    Theme = Theme.Light,
                    ChordDisplay = ChordDisplay.Above,
                    ChordDifficulty = ChordDifficulty.Medium,
                    PlayLevel = PlayLevel.Medium
                };
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading user settings");
        }
        finally
        {
            isLoadingSettings = false;
        }
    }

    private async Task SaveUserSettings()
    {
        try
        {
            IsSaving = true;
            userSettings.ShowNotifications = showNotification;
            userSettings.CreatedBy = UserId;
            var response = await _settingsApi.CreateOrUpdateUserSettings(userSettings);

            if (response.IsSuccessStatusCode)
            {
                _modalService.Show(new ModalOptionDto
                {
                    Title = "Success",
                    SubTitle = "Settings saved successfully!",
                    Message = "Changes apply on restart",
                    ButtonText = "OK",
                    OptionType = OptionType.Success,
                    Context = new ModalContext { ActionType = "Success" }
                });
            }
            else
            {
                var errorMessage = _apiResponseHandler.GetApiErrorMessage(response);
                ShowErrorModal($"Failed to save settings: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error saving settings");
            ShowErrorModal("Failed to save settings");
        }
        finally
        {
            IsSaving = false;
        }
    }

    private string GetDisplayName(SongDisplay display) => display switch
    {
        SongDisplay.LyricsOnly => "Lyrics Only",
        SongDisplay.LyricsAndChords => "Lyrics and Chords",
        SongDisplay.LyricsAndChordsAndCharts => "Lyrics, Chords and Charts",
        _ => display.ToString()
    };

    private string GetChordDisplayName(ChordDisplay display) => display switch
    {
        ChordDisplay.Inline => "Inline with Lyrics",
        ChordDisplay.Above => "Above Lyrics",
        _ => display.ToString()
    };

    private string GetDifficultyName(ChordDifficulty difficulty) => difficulty switch
    {
        ChordDifficulty.Easy => "Beginner",
        ChordDifficulty.Medium => "Intermediate",
        ChordDifficulty.Advanced => "Advanced",
        ChordDifficulty.Expert => "Expert",
        _ => difficulty.ToString()
    };

    private string GetPlayLevelName(PlayLevel level) => level switch
    {
        PlayLevel.Easy => "Beginner",
        PlayLevel.Medium => "Intermediate",
        PlayLevel.Advanced => "Advanced",
        _ => level.ToString()
    };

    private async Task ConfirmModal()
    {
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }

    private void ShowErrorModal(string message)
    {
        _modalService.Show(new ModalOptionDto
        {
            Title = "Error",
            Message = message,
            ButtonText = "OK",
            OptionType = OptionType.Error,
            Context = new ModalContext { ActionType = "Error" }
        });
    }
}