@page "/users/create"
@page "/users/edit/{userId}"
@inject ILogger<UsersAdd> _logger
@inject IAuthApi _authApi
@inject IUsersApi _usersApi
@inject ISmtpSenderApi _smtpSender
@implements IDisposable

<PageTitle>@(IsEditMode ? "Edit User" : "Create User")</PageTitle>

<div class="w-100 d-flex justify-content-center mx-auto p-4 min-vh-100">
    <div class="w-100" style="max-width: 55rem;">
        <!-- Header -->
        <div class="d-flex align-items-center mb-4">
            <button class="btn btn-link text-decoration-none p-0 me-3" @onclick="NavigateBack">
                <i class="bi bi-arrow-left fs-3 text-primary"></i>
            </button>
            <div>
                <h3 class="mb-0">@(IsEditMode ? "Edit User Profile" : "Create New User")</h3>
                <p class="text-muted mb-0">@(IsEditMode ? "Update user information and settings" : "Add a new user to the system")</p>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(error))
        {
            <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>@error
                <button type="button" class="btn-close" @onclick="() => error = string.Empty"></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
                <i class="bi bi-check-circle me-2"></i>@successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
            </div>
        }

        <!-- Stepper -->
        <div class="stepper d-flex justify-content-between mb-5">
            @foreach (var step in steps)
            {
                <div class="step flex-fill text-center position-relative">
                    @if (step.Key < currentStep || (step.Key == currentStep + 1 && CanNavigateToStep(step.Key)))
                    {
                        <button class="step-circle mx-auto @GetStepCircleClass(step.Key) btn p-0 border-0 bg-transparent"
                                @onclick="() => NavigateToStep(step.Key)"
                                disabled="@(!CanNavigateToStep(step.Key))">
                            @if (currentStep > step.Key)
                            {
                                <i class="bi bi-check text-white"></i>
                            }
                            else
                            {
                                @step.Key
                            }
                        </button>
                    }
                    else
                    {
                        <div class="step-circle mx-auto @GetStepCircleClass(step.Key)">
                            @if (currentStep > step.Key)
                            {
                                <i class="bi bi-check text-white"></i>
                            }
                            else
                            {
                                @step.Key
                            }
                        </div>
                    }
                    <div class="step-label mt-2 @GetStepLabelClass(step.Key)">@step.Value</div>
                </div>
            }
        </div>

        <!-- Multi-Step Form -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <EditForm EditContext="editContext">
                    <DataAnnotationsValidator />

                    @if (IsEditMode && !string.IsNullOrEmpty(profileModel.Id))
                    {
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted small">USER ID</label>
                            <input type="text" class="form-control" value="@profileModel.Id" readonly />
                        </div>
                    }

                    @if (currentStep == StepAccountSetup && !IsEditMode)
                    {
                        <!-- Step 1: Account Setup (Create Mode Only) -->
                        <h5 class="mb-4 text-primary"><i class="bi bi-lock me-2"></i>Account Setup</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-12">
                                <label for="email" class="form-label fw-semibold">
                                    <i class="bi bi-envelope me-1"></i>Email <span class="text-danger">*</span>
                                </label>
                                <InputText id="email" @bind-Value="profileModel.Email" class="form-control" type="email" placeholder="user@example.com" />
                                <ValidationMessage For="@(() => profileModel.Email)" class="text-danger small" />
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-12">
                                <label for="userName" class="form-label fw-semibold">
                                    <i class="bi bi-person me-1"></i>Username <span class="text-danger">*</span>
                                </label>
                                <InputText id="userName" @bind-Value="profileModel.UserName" class="form-control" placeholder="username" />
                                <ValidationMessage For="@(() => profileModel.UserName)" class="text-danger small" />
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="password" class="form-label fw-semibold">
                                    Password <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <InputText id="password" @bind-Value="profileModel.Password"
                                               class="form-control"
                                               type="@(showPassword ? "text" : "password")"
                                               placeholder="Enter password" />
                                    <button class="btn btn-outline-secondary" type="button" @onclick="TogglePasswordVisibility">
                                        <i class="bi bi-@(showPassword ? "eye-slash" : "eye")"></i>
                                    </button>
                                </div>
                                <ValidationMessage For="@(() => profileModel.Password)" class="text-danger small" />
                                <small class="text-muted">Minimum 4 characters</small>
                            </div>
                            <div class="col-md-6">
                                <label for="confirmPassword" class="form-label fw-semibold">
                                    Confirm Password <span class="text-danger">*</span>
                                </label>
                                <InputText id="confirmPassword" @bind-Value="confirmPassword"
                                           class="form-control"
                                           type="@(showPassword ? "text" : "password")"
                                           placeholder="Re-enter password" />
                                @if (!string.IsNullOrEmpty(passwordMismatchError))
                                {
                                    <div class="text-danger small mt-1">@passwordMismatchError</div>
                                }
                            </div>
                        </div>
                    }

                    @if (currentStep == StepEmailVerify && !IsEditMode)
                    {
                        <!-- Email Verification Step -->
                        <h5 class="mb-4 text-primary"><i class="bi bi-envelope-check me-2"></i>Email Verification</h5>
                        <p>We have sent a 6-digit verification code to <strong>@profileModel.Email</strong>. Please enter it below.</p>
                        <div class="mb-4">
                            <label for="emailCode" class="form-label fw-semibold">Verification Code <span class="text-danger">*</span></label>
                            <InputText id="emailCode" @bind-Value="enteredEmailCode" class="form-control" placeholder="Enter 6-digit code" maxlength="6" />
                        </div>
                        <small class="text-muted">
                            Didn't receive the code?
                            <button type="button" class="btn btn-link p-0 ms-1" @onclick="ResendEmailCode" disabled="@(emailResendCountdown > 0)">
                                @if (emailResendCountdown > 0)
                                {
                                    @($"Resend in {emailResendCountdown}s")
                                }
                                else
                                {
                                    @("Resend")
                                }
                            </button>
                        </small>
                    }

                    @if (currentStep == StepProfileDetails)
                    {
                        <!-- Step: Profile Details -->
                        <h5 class="mb-4 text-primary"><i class="bi bi-person-circle me-2"></i>Profile Details</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label fw-semibold">
                                    First Name <span class="text-danger">*</span>
                                </label>
                                <InputText id="firstName" @bind-Value="profileModel.FirstName" class="form-control" placeholder="Enter first name" />
                                <ValidationMessage For="@(() => profileModel.FirstName)" class="text-danger small" />
                            </div>
                            <div class="col-md-6">
                                <label for="lastName" class="form-label fw-semibold">
                                    Last Name <span class="text-danger">*</span>
                                </label>
                                <InputText id="lastName" @bind-Value="profileModel.LastName" class="form-control" placeholder="Enter last name" />
                                <ValidationMessage For="@(() => profileModel.LastName)" class="text-danger small" />
                            </div>
                        </div>
                        @if (IsEditMode)
                        {
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="email" class="form-label fw-semibold">
                                        <i class="bi bi-envelope me-1"></i>Email <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="email" @bind-Value="profileModel.Email" class="form-control" type="email" placeholder="user@example.com" disabled="true" />
                                    <small class="text-muted">Email cannot be changed</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="userName" class="form-label fw-semibold">
                                        <i class="bi bi-person me-1"></i>Username <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="userName" @bind-Value="profileModel.UserName" class="form-control" placeholder="username" />
                                    <ValidationMessage For="@(() => profileModel.UserName)" class="text-danger small" />
                                </div>
                            </div>
                        }
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="phoneNumber" class="form-label fw-semibold">
                                    <i class="bi bi-telephone me-1"></i>Phone Number
                                </label>
                                <InputText id="phoneNumber" @bind-Value="profileModel.PhoneNumber" class="form-control" placeholder="+1 (555) 000-0000" />
                                <ValidationMessage For="@(() => profileModel.PhoneNumber)" class="text-danger small" />
                            </div>
                            <div class="col-md-6">
                                <label for="profession" class="form-label fw-semibold">
                                    <i class="bi bi-briefcase me-1"></i>Profession
                                </label>
                                <InputText id="profession" @bind-Value="profileModel.Profession" class="form-control" placeholder="e.g., Software Developer" />
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="address" class="form-label fw-semibold">
                                <i class="bi bi-geo-alt me-1"></i>Address
                            </label>
                            <InputText id="address" @bind-Value="profileModel.Address" class="form-control" placeholder="Street address, city, state, ZIP" />
                            <ValidationMessage For="@(() => profileModel.Address)" class="text-danger small" />
                        </div>
                        <div class="mb-4">
                            <label for="aboutMe" class="form-label fw-semibold">
                                <i class="bi bi-info-circle me-1"></i>About Me
                            </label>
                            <InputTextArea id="aboutMe" @bind-Value="profileModel.AboutMe" class="form-control" rows="4" placeholder="Tell us about yourself..." />
                            <ValidationMessage For="@(() => profileModel.AboutMe)" class="text-danger small" />
                        </div>
                    }

                    @if (currentStep == StepPhoneVerify && !IsEditMode)
                    {
                        <!-- Phone Verification Step -->
                        <h5 class="mb-4 text-primary"><i class="bi bi-phone me-2"></i>Phone Verification</h5>
                        @if (!string.IsNullOrEmpty(profileModel.PhoneNumber))
                        {
                            <p>We have sent a 6-digit verification code to <strong>@profileModel.PhoneNumber</strong> via email (TODO: implement SMS). Please enter it below.</p>
                            <div class="mb-4">
                                <label for="phoneCode" class="form-label fw-semibold">Verification Code <span class="text-danger">*</span></label>
                                <InputText id="phoneCode" @bind-Value="enteredPhoneCode" class="form-control" placeholder="Enter 6-digit code" maxlength="6" />
                            </div>
                            <small class="text-muted">
                                Didn't receive the code?
                                <button type="button" class="btn btn-link p-0 ms-1" @onclick="ResendPhoneCode" disabled="@(phoneResendCountdown > 0)">
                                    @if (phoneResendCountdown > 0)
                                    {
                                        @($"Resend in {phoneResendCountdown}s")
                                    }
                                    else
                                    {
                                        @("Resend")
                                    }
                                </button>
                            </small>
                        }
                        else
                        {
                            <p>No phone number provided. Click next to continue.</p>
                        }
                    }

                    @if (currentStep == StepAccessControl)
                    {
                        <!-- Step: Access Control -->
                        <h5 class="mb-4 text-primary"><i class="bi bi-shield-check me-2"></i>Access Control</h5>
                        @if (currentUser != null && currentUser.UserType == UserType.SuperAdmin)
                        {
                            <div class="mb-4">
                                <label class="form-label fw-semibold">
                                    <i class="bi bi-building me-1"></i>Organization
                                </label>
                                <select class="form-select" @bind="profileModel.TenantId">
                                    <option value="">Select a company</option>
                                    @foreach (var tenant in tenants)
                                    {
                                        <option value="@tenant.Id">@tenant.TenantName</option>
                                    }
                                </select>
                            </div>
                        }
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-shield-check me-1"></i>Assigned Roles
                            </label>
                            <div class="row g-2">
                                @foreach (var role in availableRoles)
                                {
                                    <div class="col-md-4">
                                        <div class="form-check p-3 border rounded hover-shadow">
                                            <input class="form-check-input" type="checkbox" id="role-@role" checked="@profileModel.AssignedRoles?.Contains(role)" @onchange="(e) => ToggleRole(role, (bool)e.Value)" />
                                            <label class="form-check-label ms-2" for="role-@role">@role</label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Navigation Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        @if (currentStep > 1)
                        {
                            <button type="button" class="btn btn-outline-secondary" @onclick="PreviousStep" disabled="@(isSubmittingProfile || isChangingPassword)">
                                <i class="bi bi-arrow-left me-1"></i> Previous
                            </button>
                        }
                        @if (currentStep < steps.Count)
                        {
                            <button type="button" class="btn btn-primary ms-auto" @onclick="NextStep" disabled="@(isSubmittingProfile || isChangingPassword)">
                                Next <i class="bi bi-arrow-right me-1"></i>
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-primary ms-auto" @onclick="HandleProfileSubmit" disabled="@(isSubmittingProfile || isChangingPassword)">
                                @if (isSubmittingProfile)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-save me-1"></i> @(IsEditMode ? "Update Profile" : "Create User")
                            </button>
                        }
                    </div>
                </EditForm>

                @if (IsEditMode && currentStep == StepProfileDetails && showPasswordFields)
                {
                    <div class="mt-5">
                        <h5 class="mb-4 text-primary"><i class="bi bi-key me-2"></i>Change Password</h5>
                        <EditForm Model="passwordChangeModel" OnValidSubmit="HandlePasswordChange">
                            <DataAnnotationsValidator />
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="newPassword" class="form-label fw-semibold">
                                        New Password <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="newPassword" @bind-Value="passwordChangeModel.Password"
                                               class="form-control"
                                               type="@(showPassword ? "text" : "password")"
                                               placeholder="Enter new password" />
                                    <ValidationMessage For="@(() => passwordChangeModel.Password)" class="text-danger small" />
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmNewPassword" class="form-label fw-semibold">
                                        Confirm New Password <span class="text-danger">*</span>
                                    </label>
                                    <InputText id="confirmNewPassword" @bind-Value="confirmNewPassword"
                                               class="form-control"
                                               type="@(showPassword ? "text" : "password")"
                                               placeholder="Re-enter new password" />
                                    @if (!string.IsNullOrEmpty(passwordMismatchError))
                                    {
                                        <div class="text-danger small mt-1">@passwordMismatchError</div>
                                    }
                                </div>
                            </div>
                            <ValidationSummary class="text-danger mb-3" />
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-outline-secondary" @onclick="CancelPasswordChange" disabled="@isChangingPassword">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" disabled="@isChangingPassword">
                                    @if (isChangingPassword)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-shield-check me-1"></i>
                                    Update Password
                                </button>
                            </div>
                        </EditForm>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<DialogModal IsVisible="@_modalService.IsModalVisible"
             Modal="@_modalService.CurrentModal"
             OnCloseModal="CloseModal"
             OnConfirmModal="ConfirmModal" />

@code {
    [Parameter] public string? UserId { get; set; }

    private bool IsEditMode => !string.IsNullOrEmpty(UserId);
    private bool isSubmittingProfile = false;
    private bool isChangingPassword = false;
    private bool showPasswordFields = false;
    private bool showPassword = false;
    private string error = string.Empty;
    private string successMessage = string.Empty;
    private string confirmPassword = string.Empty;
    private string confirmNewPassword = string.Empty;
    private string passwordMismatchError = string.Empty;
    private string emailCode = string.Empty;
    private string enteredEmailCode = string.Empty;
    private string phoneCode = string.Empty;
    private string enteredPhoneCode = string.Empty;
    private int currentStep = 1;
    private int StepAccountSetup;
    private int StepEmailVerify;
    private int StepProfileDetails;
    private int StepPhoneVerify;
    private int StepAccessControl;
    private Dictionary<int, string> steps = new();
    private CreateUserProfile profileModel = new();
    private ResetPasswordDto passwordChangeModel = new();
    private List<string> availableRoles = new(UserRoles.AllRoles);
    private List<TenantDto> tenants = new();
    private UserClaimsDto? currentUser = new();
    private EditContext? editContext;
    private EmailAddressAttribute emailValidator = new();

    private int emailResendCountdown = 0;
    private int phoneResendCountdown = 0;
    private Timer? emailResendTimer;
    private Timer? phoneResendTimer;

    protected override async Task OnInitializedAsync()
    {
        editContext = new EditContext(profileModel);
        currentUser = await _globalAuth.GetLoggedInUserAsync();
        await LoadTenants();

        if (IsEditMode)
        {
            await LoadUser();
            steps = new Dictionary<int, string>
            {
                {1, "Profile Details"},
                {2, "Access Control"}
            };
            StepProfileDetails = 1;
            StepAccessControl = 2;
        }
        else
        {
            // Initialize with default values for new user
            profileModel = new CreateUserProfile
            {
                AssignedRoles = new List<string> { "User" }
            };

            steps = new Dictionary<int, string>
            {
                {1, "Account Setup"},
                {2, "Email Verification"},
                {3, "Profile Details"},
                {4, "Phone Verification"},
                {5, "Access Control"}
            };
            StepAccountSetup = 1;
            StepEmailVerify = 2;
            StepProfileDetails = 3;
            StepPhoneVerify = 4;
            StepAccessControl = 5;
        }
        //test details
        profileModel = new CreateUserProfile
        {
            FirstName = "John",
            LastName = "Doe",
            Email = "johndoe@example.com",
            UserName = "johndoe",
            PhoneNumber = "+1 (555) 123-4567",
            Address = "123 Main St, Anytown, USA",
            AboutMe = "A passionate developer with a love for coding.",
            Profession = "Software Developer",
            AssignedRoles = new List<string> { "User" }
        };

    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsEditMode && !string.IsNullOrEmpty(UserId))
        {
            await LoadUser();
        }
    }

    private async Task LoadUser()
    {
        try
        {
            error = string.Empty;
            var response = await _usersApi.GetUserProfile(UserId);

            if (response.IsSuccessStatusCode && response.Content != null)
            {
                var userProfile = response.Content;
                profileModel = new CreateUserProfile
                {
                    Id = userProfile.Id,
                    FirstName = userProfile.FirstName,
                    LastName = userProfile.LastName,
                    PhoneNumber = userProfile.PhoneNumber,
                    Address = userProfile.Address,
                    AboutMe = userProfile.AboutMe,
                    Profession = userProfile.Profession,
                    ProfilePicUrl = userProfile.ProfilePicUrl,
                    CoverPhotoUrl = userProfile.CoverPhotoUrl,
                    AssignedRoles = userProfile.AssignedRoles ?? new(),
                    TenantId = userProfile.TenantId
                };

                // Initialize password change model with user email
                passwordChangeModel = new ResetPasswordDto
                {
                    EmailAddress = userProfile.Email ?? string.Empty
                };
            }
            else
            {
                error = _apiResponseHandler.GetApiErrorMessage(response);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading user {UserId}", UserId);
            error = "Failed to load user information.";
        }
    }

    private async Task LoadTenants()
    {
        try
        {
            var response = await _tenantsApi.GetAllTenants(0, 100);
            if (response.IsSuccessStatusCode && response.Content != null)
            {
                tenants = response.Content.Data!;
            }
            else
            {
                _logger.LogWarning("Failed to load tenants {Error}", _apiResponseHandler.GetApiErrorMessage(response));
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error loading tenants");
        }
    }

    private async Task HandleProfileSubmit()
    {
        error = string.Empty;
        passwordMismatchError = string.Empty;
        if (editContext == null || !editContext.Validate())
        {
            error = "Please fill in all required fields correctly.";
            return;
        }

        try
        {
            isSubmittingProfile = true;

            if (IsEditMode)
            {
                var profileEdit = new UpdateUserProfile
                {
                    Id = profileModel.Id,
                    FirstName = profileModel.FirstName,
                    LastName = profileModel.LastName,
                    PhoneNumber = profileModel.PhoneNumber,
                    Address = profileModel.Address,
                    AboutMe = profileModel.AboutMe,
                    Profession = profileModel.Profession,
                    ProfilePicUrl = profileModel.ProfilePicUrl,
                    CoverPhotoUrl = profileModel.CoverPhotoUrl,
                    AssignedRoles = profileModel.AssignedRoles,
                    TenantId = profileModel.TenantId
                };

                var response = await _usersApi.EditUserProfile(profileEdit);

                if (response.IsSuccessStatusCode)
                {
                    successMessage = "Profile updated successfully!";
                    await Task.Delay(1500);
                    NavigateBack();
                }
                else
                {
                    error = _apiResponseHandler.GetApiErrorMessage(response);
                }
            }
            else
            {
                // Validate password for new user
                if (string.IsNullOrEmpty(profileModel.Password))
                {
                    error = "Password is required for new users.";
                    return;
                }

                if (profileModel.Password != confirmPassword)
                {
                    passwordMismatchError = "Passwords do not match.";
                    return;
                }

                // Create new user with password
                var createUserDto = new CreateUserDto
                {
                    FirstName = profileModel.FirstName,
                    LastName = profileModel.LastName,
                    Email = profileModel.Email ?? string.Empty,
                    UserName = profileModel.UserName ?? string.Empty,
                    Password = profileModel.Password,
                    PhoneNumber = profileModel.PhoneNumber,
                    Address = profileModel.Address,
                    AboutMe = profileModel.AboutMe,
                    ProfilePicUrl = profileModel.ProfilePicUrl,
                    CoverPhotoUrl = profileModel.CoverPhotoUrl,
                    AssignedRoles = profileModel.AssignedRoles,
                    TenantId = profileModel.TenantId
                };

                var response = await _authApi.CreateUser(createUserDto);

                if (response.IsSuccessStatusCode)
                {
                    successMessage = "User created successfully!";
                    await Task.Delay(1500);
                    NavigateBack();
                }
                else
                {
                    error = _apiResponseHandler.GetApiErrorMessage(response);
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error saving user profile");
            error = "An error occurred while saving the profile.";
        }
        finally
        {
            isSubmittingProfile = false;
            StateHasChanged();
        }
    }

    private async Task HandlePasswordChange()
    {
        try
        {
            error = string.Empty;
            passwordMismatchError = string.Empty;
            isChangingPassword = true;

            // Validate password confirmation
            if (passwordChangeModel.Password != confirmNewPassword)
            {
                passwordMismatchError = "New passwords do not match.";
                return;
            }

            var response = await _authApi.ResetPassword(passwordChangeModel);

            if (response.IsSuccessStatusCode)
            {
                successMessage = "Password changed successfully!";
                showPasswordFields = false;
                passwordChangeModel = new ResetPasswordDto { EmailAddress = passwordChangeModel.EmailAddress };
                confirmNewPassword = string.Empty;
            }
            else
            {
                error = _apiResponseHandler.GetApiErrorMessage(response);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error changing password for user {UserId}", UserId);
            error = "An error occurred while changing the password.";
        }
        finally
        {
            isChangingPassword = false;
            StateHasChanged();
        }
    }

    private void CancelPasswordChange()
    {
        showPasswordFields = false;
        passwordChangeModel = new ResetPasswordDto { EmailAddress = passwordChangeModel.EmailAddress };
        confirmNewPassword = string.Empty;
        passwordMismatchError = string.Empty;
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleRole(string role, bool isSelected)
    {
        profileModel.AssignedRoles ??= new List<string>();

        if (isSelected)
        {
            if (!profileModel.AssignedRoles.Contains(role))
            {
                profileModel.AssignedRoles.Add(role);
            }
        }
        else
        {
            profileModel.AssignedRoles.Remove(role);
        }
    }

    private async Task NextStep()
    {
        error = string.Empty;
        passwordMismatchError = string.Empty;

        if (!IsEditMode)
        {
            if (currentStep == StepAccountSetup)
            {
                if (string.IsNullOrEmpty(profileModel.Email) || !emailValidator.IsValid(profileModel.Email))
                {
                    error = "Please provide a valid email address.";
                    return;
                }
                if (string.IsNullOrEmpty(profileModel.UserName))
                {
                    error = "Username is required.";
                    return;
                }
                if (string.IsNullOrEmpty(profileModel.Password) || profileModel.Password.Length < 4)
                {
                    error = "Password must be at least 4 characters.";
                    return;
                }
                if (profileModel.Password != confirmPassword)
                {
                    passwordMismatchError = "Passwords do not match.";
                    return;
                }
                await SendVerificationCodeToEmail();
                currentStep++;
                return;
            }
            else if (currentStep == StepEmailVerify)
            {
                if (enteredEmailCode != emailCode)
                {
                    error = "Invalid verification code.";
                    return;
                }
                enteredEmailCode = string.Empty;
                successMessage = string.Empty;
                currentStep++;
                return;
            }
            else if (currentStep == StepProfileDetails)
            {
                if (string.IsNullOrEmpty(profileModel.FirstName))
                {
                    error = "First name is required.";
                    return;
                }
                if (string.IsNullOrEmpty(profileModel.LastName))
                {
                    error = "Last name is required.";
                    return;
                }
                if (!string.IsNullOrEmpty(profileModel.PhoneNumber))
                {
                    await SendVerificationCodeToPhone();
                }
                else
                {
                    currentStep++;
                }
                successMessage = string.Empty;
                currentStep++;
                return;
            }
            else if (currentStep == StepPhoneVerify)
            {
                if (!string.IsNullOrEmpty(profileModel.PhoneNumber) && enteredPhoneCode != phoneCode)
                {
                    error = "Invalid verification code.";
                    return;
                }
                enteredPhoneCode = string.Empty;
                currentStep++;
                return;
            }
        }
        else
        {
            if (currentStep == StepProfileDetails)
            {
                if (string.IsNullOrEmpty(profileModel.FirstName))
                {
                    error = "First name is required.";
                    return;
                }
                if (string.IsNullOrEmpty(profileModel.LastName))
                {
                    error = "Last name is required.";
                    return;
                }
                currentStep++;
                return;
            }
        }

        currentStep++;
    }

    private void PreviousStep()
    {
        error = string.Empty;
        passwordMismatchError = string.Empty;
        currentStep--;
    }

    private bool CanNavigateToStep(int targetStep)
    {
        // Allow navigation to previous steps and the immediate next step
        return targetStep <= currentStep || targetStep == currentStep + 1;
    }

    private void NavigateToStep(int targetStep)
    {
        if (CanNavigateToStep(targetStep))
        {
            error = string.Empty;
            passwordMismatchError = string.Empty;
            currentStep = targetStep;
        }
    }

    private string GetStepCircleClass(int step)
    {
        if (currentStep > step)
            return "completed";
        if (currentStep == step)
            return "active";
        return "";
    }

    private string GetStepLabelClass(int step)
    {
        if (step <= currentStep)
            return "fw-semibold text-dark";
        return "text-muted";
    }

    private async Task SendVerificationCodeToEmail()
    {
        try
        {
            var random = new Random();
            emailCode = random.Next(100000, 999999).ToString();

            var emailDto = new EmailDto(true)
            {
                ToEmail = profileModel.Email,
                Subject = "Email Verification Code",
                Body = $"Your 6-digit verification code is: <h2>{emailCode}</h2><br/>This code will expire in 5 minutes."
            };

            var result = await _smtpSender.SendMail(emailDto);
            if (!result.IsSuccessStatusCode)
            {
                error = "Failed to send verification code. Please try again.";
            }
            else
            {
                successMessage = "Verification code sent successfully.";
                StartEmailResendTimer();
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error sending email verification code");
            error = "An error occurred while sending the verification code.";
        }
    }

    private async Task ResendEmailCode()
    {
        error = string.Empty;
        if (emailResendCountdown == 0)
        {
            await SendVerificationCodeToEmail();
        }
    }

    private async Task SendVerificationCodeToPhone()
    {
        try
        {
            var random = new Random();
            phoneCode = random.Next(100000, 999999).ToString();

            // TODO: Implement actual SMS sending here. For now, sending via email as placeholder.
            var emailDto = new EmailDto(true)
            {
                ToEmail = profileModel.Email,
                Subject = "Phone Verification Code",
                Body = $"Your 6-digit verification code is: <h2>{phoneCode}</h2><br/>This code will expire in 5 minutes."
            };

            var result = await _smtpSender.SendMail(emailDto);
            if (!result.IsSuccessStatusCode)
            {
                error = "Failed to send verification code. Please try again.";
            }
            else
            {
                StartPhoneResendTimer();
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error sending phone verification code");
            error = "An error occurred while sending the verification code.";
        }
    }

    private async Task ResendPhoneCode()
    {
        await SendVerificationCodeToPhone();
        successMessage = "Verification code resent successfully.";
    }

    private void StartEmailResendTimer()
    {
        emailResendCountdown = 45;
        emailResendTimer?.Dispose();
        emailResendTimer = new Timer(
            callback: _ =>
            {
                emailResendCountdown--;
                if (emailResendCountdown <= 0)
                {
                    emailResendTimer?.Dispose();
                }
                InvokeAsync(StateHasChanged);
            },
            state: null,
            dueTime: TimeSpan.FromSeconds(1),
            period: TimeSpan.FromSeconds(1)
        );
    }

    private void StartPhoneResendTimer()
    {
        phoneResendCountdown = 45;
        phoneResendTimer?.Dispose();
        phoneResendTimer = new Timer(
            callback: _ =>
            {
                phoneResendCountdown--;
                if (phoneResendCountdown <= 0)
                {
                    phoneResendTimer?.Dispose();
                }
                InvokeAsync(StateHasChanged);
            },
            state: null,
            dueTime: TimeSpan.FromSeconds(1),
            period: TimeSpan.FromSeconds(1)
        );
    }

    private async void NavigateBack()
    {
        if (currentStep > 1)
        {
            _modalService.Show(new ModalOptionDto
            {
                Title = "Unsaved Changes",
                Message = "You have unsaved changes. Are you sure you want to leave without saving?",
                DangerText = "This action cannot be undone.",
                ButtonText = "Yes, Leave",
                OptionType = OptionType.Warning,
                Context = new ModalContext { ActionType = "navigateBack" }
            });
        }
        else
        {
            await JsRt.InvokeVoidAsync("goBack");
        }
    }

    private async Task ConfirmModal()
    {
        if (_modalService.CurrentModal?.Context?.ActionType == "navigateBack")
        {
            _modalService.Close();
            await JsRt.InvokeVoidAsync("goBack");
        }
        // Handle confirmation logic here
        await CloseModal();
    }

    private async Task CloseModal()
    {
        await Task.Delay(100);
        _modalService.Close();
        StateHasChanged();
    }

    public void Dispose()
    {
        emailResendTimer?.Dispose();
        phoneResendTimer?.Dispose();
    }
}